<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGI.AI - Gest√£o de Implanta√ß√£o Inteligente</title>
    
    <!-- Tailwind CSS para estiliza√ß√£o r√°pida e moderna -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Biblioteca de √çcones Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Biblioteca de Gr√°ficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- Biblioteca para ler arquivos Excel (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados para complementar o Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A192F; /* Azul noturno, cor prim√°ria */
            color: #E2E8F0; /* Texto claro */
        }

        /* Anima√ß√£o para o gradiente dos bot√µes e menus */
        .gradient-bg {
            background-image: linear-gradient(to right, #2DD4BF, #3B82F6);
            background-size: 200% auto;
            transition: background-position 0.5s ease;
        }

        .gradient-bg:hover {
            background-position: right center;
        }
        
        /* Efeito de brilho sutil nos cards */
        .card-hover-effect {
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: #3B82F6;
        }

        /* Anima√ß√£o para o "Insight da IA" */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .ai-insight-glow {
            animation: fadeInOut 5s infinite;
        }

        /* Estilos para a barra de rolagem */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1E2A47; }
        ::-webkit-scrollbar-thumb {
            background-color: #3B82F6;
            border-radius: 10px;
            border: 2px solid #1E2A47;
        }

        .checkbox-container {
            max-height: 150px;
            overflow-y: auto;
            background-color: #0A192F;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }

        /* Estilo para o Kanban/Checklist */
        .kanban-column {
            min-width: 300px;
            background-color: rgba(10, 25, 47, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
        }
    </style>
</head>
<body class="flex antialiased">

    <!-- Sidebar / Menu Lateral -->
    <aside class="w-64 bg-[#112240] h-screen p-4 flex flex-col justify-between fixed">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <div class="p-2 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-lg">
                    <i data-lucide="sitemap" class="text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">SGI.<span class="text-cyan-400">AI</span></h1>
            </div>
            <nav>
                <ul class="space-y-1">
                    <li><a href="#" data-target="dashboard-view" class="flex items-center gap-3 p-3 rounded-lg text-white font-semibold gradient-bg"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
                    <li><a href="#" data-target="projetos-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="folder-kanban"></i> Projetos</a></li>
                    <li><a href="#" data-target="ideias-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="lightbulb"></i> Ideias</a></li>
                    <li><a href="#" data-target="mensagens-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="message-circle"></i> Mensagens</a></li>
                    <li><a href="#" data-target="cadastros-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="database"></i> Cadastros</a></li>
                    <li><a href="#" data-target="relatorios-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="bar-chart-3"></i> Relat√≥rios</a></li>
                    <li><a href="#" data-target="configuracoes-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="settings"></i> Configura√ß√µes</a></li>
                </ul>
            </nav>
        </div>

        <!-- Se√ß√£o do Insight da IA -->
        <div id="ai-insight-box" class="p-4 bg-slate-900 rounded-lg border border-cyan-400/30 ai-insight-glow">
            <div class="flex items-center gap-2 mb-2"><i data-lucide="lightbulb" class="text-cyan-400"></i><h3 class="font-semibold text-cyan-400">Insight da IA</h3></div>
            <p id="ai-insight-text" class="text-sm text-slate-300">Analisando dados...</p>
        </div>

    </aside>

    <!-- Conte√∫do Principal -->
    <main class="flex-1 ml-64 p-8 overflow-y-auto h-screen">
        
        <!-- ########## VIEW: DASHBOARD ########## -->
        <div id="dashboard-view" data-view>
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Dashboard Principal</h2><button id="add-project-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle"></i> Novo Projeto</button></header>
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Projetos Ativos üöÄ</h3><i data-lucide="rocket" class="text-blue-400"></i></div>
                    <p id="kpi-projetos-ativos" class="text-4xl font-bold mt-2">0</p>
                </div>
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Projetos em Risco üò®</h3><i data-lucide="alert-triangle" class="text-yellow-400"></i></div>
                    <p id="kpi-projetos-risco" class="text-4xl font-bold mt-2">0</p>
                </div>
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Taxa de Sucesso üéØ</h3><i data-lucide="target" class="text-green-400"></i></div>
                    <p id="kpi-taxa-sucesso" class="text-4xl font-bold mt-2">0%</p>
                </div>
                 <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Tempo M√©dio (dias) ‚è≥</h3><i data-lucide="timer" class="text-cyan-400"></i></div>
                    <p id="kpi-tempo-medio" class="text-4xl font-bold mt-2">0</p>
                </div>
            </section>
            
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-[#1E2A47] p-6 rounded-xl">
                    <h3 class="text-xl font-bold mb-4">Acompanhamento de Implanta√ß√µes</h3>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">Cliente / Projeto</th><th class="p-3">Status</th><th class="p-3">Progresso</th><th class="p-3">A√ß√µes</th></tr></thead><tbody id="projects-table-body"></tbody></table></div>
                </div>
                <div class="bg-[#1E2A47] p-6 rounded-xl">
                     <h3 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="trophy" class="text-yellow-400"></i> Gamifica√ß√£o da Equipe</h3>
                    <div id="gamification-container" class="space-y-4 max-h-80 overflow-y-auto"></div>
                </div>
            </section>
        </div>

        <!-- ########## VIEW: PROJETOS ########## -->
        <div id="projetos-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Gerenciamento de Projetos üìÇ</h2></header>
            <section id="project-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></section>
        </div>

        <!-- ########## VIEW: IDEIAS ########## -->
        <div id="ideias-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Banco de Ideias üí°</h2><button id="add-ideia-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Nova Ideia</button></header>
            <section id="ideias-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></section>
        </div>

        <!-- ########## VIEW: MENSAGENS ########## -->
        <div id="mensagens-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Mensagens Personalizadas üí¨</h2><button id="add-mensagem-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Nova Mensagem</button></header>
            <section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">T√≠tulo</th><th class="p-3">Mensagem</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="mensagens-table-body"></tbody></table></section>
        </div>

        <!-- ########## VIEW: BASE DE CONHECIMENTO ########## -->
        <div id="kb-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Base de Conhecimento üìñ</h2><button id="add-kb-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Novo Artigo</button></header>
            <section id="kb-container" class="space-y-4"></section>
        </div>

        <!-- ########## VIEW: CADASTROS ########## -->
        <div id="cadastros-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Cadastros Gerais ‚öôÔ∏è</h2></header>
            <div class="mb-6 border-b border-slate-700"><nav class="flex space-x-8" aria-label="Tabs"><a href="#" data-tab="equipes" class="tab-link text-cyan-400 border-cyan-400 py-4 px-1 border-b-2 font-medium text-lg">Equipes</a><a href="#" data-tab="sistemas" class="tab-link text-slate-400 border-transparent hover:text-slate-200 py-4 px-1 border-b-2 font-medium text-lg">Sistemas</a><a href="#" data-tab="clientes" class="tab-link text-slate-400 border-transparent hover:text-slate-200 py-4 px-1 border-b-2 font-medium text-lg">Clientes</a><a href="#" data-tab="status" class="tab-link text-slate-400 border-transparent hover:text-slate-200 py-4 px-1 border-b-2 font-medium text-lg">Status</a></nav></div>
            <div id="equipes-tab" class="tab-content"><header class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Membros da Equipe</h3><div class="flex items-center gap-4"><button id="import-team-btn" data-import-type="team" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="upload"></i> Importar</button><button id="add-team-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="user-plus"></i> Adicionar</button></div></header><section id="team-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></section></div>
            <div id="sistemas-tab" class="tab-content hidden"><div class="flex justify-end mb-4 gap-4"><button id="import-sistema-btn" data-import-type="sistema" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="upload"></i> Importar</button><button id="add-sistema-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Adicionar Sistema</button></div><section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">Nome do Sistema</th><th class="p-3">Tipo</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="sistemas-table-body"></tbody></table></section></div>
            <div id="clientes-tab" class="tab-content hidden"><div class="flex justify-end mb-4 gap-4"><button id="import-client-btn" data-import-type="cliente" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="upload"></i> Importar</button><button id="add-cliente-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Adicionar Cliente</button></div><section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">Nome do Cliente</th><th class="p-3">Cidade</th><th class="p-3">Respons√°vel</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="clientes-table-body"></tbody></table></section></div>
            <div id="status-tab" class="tab-content hidden"><div class="flex justify-end mb-4"><button id="add-status-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Adicionar Status</button></div><section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">Nome do Status</th><th class="p-3">Cor</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="status-table-body"></tbody></table></section></div>
        </div>
        <input type="file" id="import-input" class="hidden" accept=".csv, .xls, .xlsx">

        <!-- ########## VIEW: RELAT√ìRIOS ########## -->
        <div id="relatorios-view" data-view class="hidden">
             <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Relat√≥rios & An√°lises üìà</h2></header>
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect"><h3 class="font-bold text-lg mb-4 text-center">Projetos por Status</h3><div class="h-64 flex items-center justify-center"><canvas id="statusChart"></canvas></div></div>
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect"><h3 class="font-bold text-lg mb-4 text-center">Carga de Trabalho (Ger. T√©cnico)</h3><div class="h-72 flex items-center justify-center"><canvas id="managerChart"></canvas></div></div>
                 <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect"><h3 class="font-bold text-lg mb-4 text-center">Carga de Trabalho (Ger. Comercial)</h3><div class="h-72 flex items-center justify-center"><canvas id="commercialManagerChart"></canvas></div></div>
            </section>
        </div>
        
        <!-- ########## VIEW: CONFIGURA√á√ïES ########## -->
        <div id="configuracoes-view" data-view class="hidden">
             <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Configura√ß√µes do Sistema üîß</h2></header>
            <section class="bg-[#1E2A47] p-8 rounded-xl space-y-8">
                <div>
                    <h3 class="text-xl font-bold mb-2">Backup e Restaura√ß√£o de Dados</h3><p class="text-slate-400 mb-6">Salve todos os dados ou restaure a partir de um backup.</p>
                    <div class="flex items-center gap-4"><button id="backup-btn" class="gradient-bg text-white font-semibold py-3 px-6 rounded-lg flex items-center gap-2"><i data-lucide="download-cloud"></i> Fazer Backup</button><button id="restore-btn" class="bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg flex items-center gap-2"><i data-lucide="upload-cloud"></i> Restaurar Backup</button></div>
                    <input type="file" id="restore-input" class="hidden" accept=".json">
                </div>
            </section>
        </div>
    </main>

    <!-- Modal para Adicionar/Editar Projeto -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center overflow-y-auto hidden z-50 p-4 pt-16">
        <div class="bg-[#1E2A47] p-6 md:p-8 rounded-xl w-full max-w-5xl lg:max-w-6xl 2xl:max-w-7xl max-h-[85vh] overflow-y-auto transform transition-all scale-95 opacity-0" id="project-modal-content">
            <div class="flex justify-between items-center mb-6"><h3 id="project-modal-title" class="text-2xl font-bold"></h3><button id="close-modal-btn" class="text-slate-400"><i data-lucide="x-circle"></i></button></div>
            <form id="project-form">
                <input type="hidden" id="projectId">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-x-8 gap-y-6">
                    <!-- Coluna 1: Dados & Sele√ß√µes -->
                    <div class="lg:col-span-1 space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block mb-2 text-sm">Cliente</label><select id="cliente-select" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                            <div><label class="block mb-2 text-sm">Cidade</label><input type="text" id="cidade" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>
                            <div><label class="block mb-2 text-sm">Data de In√≠cio</label><input type="date" id="dataInicio" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>
                            <div><label class="block mb-2 text-sm">Previs√£o de Conclus√£o</label><input type="date" id="dataPrevisao" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>
                            <div><label class="block mb-2 text-sm">Ger. Comercial</label><select id="ger-comercial" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                            <div><label class="block mb-2 text-sm">Ger. T√©cnica</label><select id="ger-tecnica" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                            <div><label class="block mb-2 text-sm">Status</label><select id="status-select" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                            <div><label class="block mb-2 text-sm">Progresso (%)</label><input type="number" id="progresso" class="w-full bg-slate-700 p-2.5 rounded-lg" required min="0" max="100"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm">Sistemas a Implantar</label>
                            <div class="flex gap-2">
                                <select id="sistemas-select-add" class="w-full bg-slate-700 p-2.5 rounded-lg"></select>
                                <button type="button" id="add-sistema-to-project-btn" class="bg-cyan-500 text-white p-2.5 rounded-lg flex-shrink-0"><i data-lucide="plus"></i></button>
                            </div>
                            <div id="sistemas-tags-container" class="mt-2 flex flex-wrap gap-2"></div>
                        </div>
                        <div><label class="block mb-2 text-sm">Equipe do Projeto</label><div id="equipe-checkboxes" class="checkbox-container space-y-2"></div></div>
                         <div><label class="block mb-2 text-sm">Atribui√ß√£o de M√≥dulos</label><div id="module-assignment-container" class="space-y-4 bg-slate-900/50 p-4 rounded-lg min-h-[150px] checkbox-container"></div></div>
                    </div>
                    <!-- Coluna 2: Kanban/Checklist e Observa√ß√µes -->
                    <div class="lg:col-span-2 space-y-4">
                        <h4 class="text-lg font-semibold">Checklist de Implanta√ß√£o (Kanban)</h4>
                        <div id="kanban-container" class="flex gap-4 overflow-x-auto pb-4"></div>
                        <div><label class="block mb-2 text-sm">Observa√ß√µes</label><div id="observacoes-container" class="space-y-2 max-h-48 overflow-y-auto bg-slate-900/50 p-3 rounded-lg min-h-[100px]"></div></div>
                        <div><label class="block mb-2 text-sm">Adicionar Nova Observa√ß√£o</label><textarea id="nova-observacao" rows="3" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="Digite aqui o motivo de um atraso, problema ou provid√™ncia..."></textarea></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4"><button type="button" id="cancel-btn" class="bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button type="submit" class="gradient-bg font-semibold py-2 px-6 rounded-lg">Salvar Projeto</button></div>
            </form>
        </div>
    </div>

    <!-- Modal Universal (Add/Edit Equipe, Sistema, Cliente, Status, Ideia, KB, Mensagem) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-start overflow-y-auto hidden z-50 p-4 pt-16">
        <div class="bg-[#1E2A47] p-8 rounded-xl w-full max-w-xl transform transition-all scale-95 opacity-0" id="edit-modal-content-wrapper">
            <div class="flex justify-between items-center mb-6"><h3 id="edit-modal-title" class="text-2xl font-bold"></h3><button id="close-edit-modal-btn" class="text-slate-400"><i data-lucide="x-circle"></i></button></div>
            <form id="edit-form">
                <div id="edit-form-content" class="space-y-4"></div>
                <div class="mt-8 flex justify-end gap-4"><button type="button" id="cancel-edit-btn" class="bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button type="submit" class="gradient-bg font-semibold py-2 px-6 rounded-lg">Salvar</button></div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Mensagem WhatsApp -->
    <div id="whatsapp-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-[#1E2A47] p-8 rounded-xl w-full max-w-lg transform transition-all scale-95 opacity-0">
             <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">Selecionar Mensagem</h3><button id="close-whatsapp-modal-btn" class="text-slate-400"><i data-lucide="x-circle"></i></button></div>
             <div id="whatsapp-message-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-[#1E2A47] p-8 rounded-xl w-full max-w-md transform transition-all scale-95 opacity-0" id="confirm-modal-content">
            <h3 id="confirm-title" class="text-xl font-bold mb-4"></h3><p id="confirm-message" class="text-slate-300 mb-8"></p>
            <div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button id="confirm-ok-btn" class="bg-red-600 font-semibold py-2 px-6 rounded-lg">Confirmar</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // --- DADOS DO SISTEMA ---
            let teamMembers = [];
            let sistemas = [];
            let clientes = [];
            let statuses = [
                { id: "ST1", text: "Planejamento", color: "#64748B" }, { id: "ST2", text: "Execu√ß√£o", color: "#3B82F6" },
                { id: "ST3", text: "Homologa√ß√£o", color: "#A855F7" }, { id: "ST4", text: "Risco", color: "#EF4444" },
                { id: "ST5", text: "Conclu√≠do", color: "#22C55E" },
            ];
            let projects = [];
            let ideias = [];
            let knowledgeBase = [];
            let whatsappMessages = [];
            let importContext = null;

            const importInput = document.getElementById('import-input');

            // --- L√ìGICA DE RENDERIZA√á√ÉO ---
            let chartInstances = {};
            
            function getStatusPill(statusId) {
                 const status = statuses.find(s => s.id === statusId) || { text: 'N/A', color: '#808080' };
                const emojis = { Planejamento: '‚è≥', Execu√ß√£o: 'üü°', Homologa√ß√£o: 'üü†', Risco: '‚ùó', Conclu√≠do: '‚úÖ' };
                return `<span style="background-color:${status.color}40; color:${status.color}" class="py-1 px-3 rounded-full text-sm font-semibold">${status.text} ${emojis[status.text] || ''}</span>`;
            }
            
            function generateAvatarInitials(name) {
                if (!name || typeof name !== 'string') return '??';
                const parts = name.trim().split(' ').filter(Boolean);
                if (parts.length > 1) {
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                } else if (parts.length === 1) {
                    return parts[0].substring(0, 2).toUpperCase();
                }
                return '??';
            }

            function generateUniqueId(prefix) {
                return `${prefix}${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
            }

            function sanitizeText(value) {
                if (value === undefined || value === null) return '';
                return String(value).trim();
            }

            function normalizeNumericString(value) {
                if (value === undefined || value === null || value === '') return '';
                if (typeof value === 'number' && Number.isFinite(value)) {
                    return Math.round(value).toString();
                }
                const text = sanitizeText(value);
                if (!text) return '';
                const numericValue = Number(text.replace(',', '.'));
                if (!Number.isNaN(numericValue)) {
                    return Math.round(numericValue).toString();
                }
                return text.replace(/\D/g, '');
            }

            function mapRowsToObjects(rows, config, builder) {
                if (!Array.isArray(rows) || rows.length === 0) return [];
                const headerRowRaw = Array.isArray(rows[0]) ? rows[0] : [];
                const headerRow = headerRowRaw.map(cell => sanitizeText(cell).toLowerCase());
                const hasHeader = config.some(item => item.keys.some(key => headerRow.includes(key)));
                const dataRows = hasHeader ? rows.slice(1) : rows;

                return dataRows.map(row => {
                    if (!Array.isArray(row) || row.every(cell => sanitizeText(cell) === '')) return null;
                    const values = {};
                    config.forEach(item => {
                        let value = '';
                        if (hasHeader) {
                            const index = headerRow.findIndex(headerCell => item.keys.includes(headerCell));
                            if (index !== -1) value = row[index];
                        } else if (typeof item.defaultIndex === 'number') {
                            value = row[item.defaultIndex];
                        }
                        values[item.field] = value;
                    });
                    return builder(values, row, { hasHeader });
                }).filter(Boolean);
            }

            function handleImportData(type, rows) {
                if (!Array.isArray(rows) || rows.length === 0) return 0;
                let imported = [];

                if (type === 'team') {
                    const config = [
                        { field: 'nome', keys: ['nome', 'name'], defaultIndex: 0 },
                        { field: 'cargo', keys: ['fun√ß√£o', 'funcao', 'cargo', 'role'], defaultIndex: 1 },
                        { field: 'email', keys: ['e-mail', 'email'], defaultIndex: 2 },
                        { field: 'telefone', keys: ['telefone', 'phone', 'celular', 'whatsapp'], defaultIndex: 3 },
                    ];
                    imported = mapRowsToObjects(rows, config, values => {
                        const nome = sanitizeText(values.nome);
                        const cargo = sanitizeText(values.cargo);
                        if (!nome || !cargo) return null;
                        const email = sanitizeText(values.email);
                        const telefone = normalizeNumericString(values.telefone);
                        return {
                            id: generateUniqueId('TM'),
                            nome,
                            cargo,
                            email,
                            telefone,
                            avatar: generateAvatarInitials(nome),
                            skills: ['Importado'],
                        };
                    });
                    if (imported.length) {
                        teamMembers = imported;
                    }
                }

                if (type === 'sistema') {
                    const config = [
                        { field: 'sigla', keys: ['sigla', 'c√≥digo', 'codigo'], defaultIndex: 0 },
                        { field: 'nome', keys: ['sistema', 'nome', 'name'], defaultIndex: 1 },
                        { field: 'tipo', keys: ['web/desk', 'tipo', 'plataforma'], defaultIndex: 2 },
                    ];
                    imported = mapRowsToObjects(rows, config, values => {
                        const nome = sanitizeText(values.nome);
                        if (!nome) return null;
                        const sigla = sanitizeText(values.sigla);
                        const tipo = sanitizeText(values.tipo) || 'N√£o informado';
                        const idBase = sigla || nome;
                        const id = idBase ? idBase.replace(/\s+/g, '').toUpperCase() : generateUniqueId('SIS');
                        return { id, nome, tipo };
                    });
                    if (imported.length) {
                        sistemas = imported;
                    }
                }

                if (type === 'cliente') {
                    const config = [
                        { field: 'cnpj', keys: ['cnpj'], defaultIndex: 0 },
                        { field: 'nome', keys: ['cliente', 'nome', 'raz√£o social', 'razao social'], defaultIndex: 1 },
                        { field: 'cidade', keys: ['cidade', 'munic√≠pio', 'municipio', 'city'], defaultIndex: 2 },
                        { field: 'uf', keys: ['uf', 'estado', 'state'], defaultIndex: 3 },
                        { field: 'responsavel', keys: ['respons√°vel', 'responsavel', 'contato', 'respons√°vel comercial', 'responsavel comercial'] },
                    ];
                    imported = mapRowsToObjects(rows, config, values => {
                        const nome = sanitizeText(values.nome);
                        if (!nome) return null;
                        const cidadeBase = sanitizeText(values.cidade);
                        const uf = sanitizeText(values.uf);
                        const cidade = uf ? [cidadeBase, uf].filter(Boolean).join(' - ') : (cidadeBase || 'N√£o informado');
                        const responsavel = sanitizeText(values.responsavel) || 'N√£o informado';
                        const cnpj = normalizeNumericString(values.cnpj);
                        const id = cnpj ? `CL${cnpj}` : generateUniqueId('CL');
                        return { id, nome, cidade, responsavel, cnpj };
                    });
                    if (imported.length) {
                        clientes = imported;
                    }
                }

                return imported.length;
            }

            function renderAll() {
                renderProjects(); renderTeam(); renderSistemas(); renderClientes(); renderStatuses();
                renderReports(); updateKPIs(); analyzeDataForAI(); renderIdeias();
                renderWhatsappMessages();
                lucide.createIcons();
            }

            function renderProjects() {
                const tableBody = document.getElementById('projects-table-body');
                const projectCardsContainer = document.getElementById('project-cards-container');
                if (!tableBody || !projectCardsContainer) return;
                tableBody.innerHTML = ''; projectCardsContainer.innerHTML = ''; 
                projects.forEach(p => {
                    const cliente = clientes.find(c => c.id === p.clienteId);
                    const projectSistemas = (p.sistemasIds || []).map(sId => sistemas.find(s => s.id === sId)?.nome).filter(Boolean).join(', ');

                    const tableRowHTML = `<tr class="hover:bg-slate-700/50">
                            <td class="p-3"><div class="font-bold">${cliente?.nome || 'N/A'}</div><div class="text-sm text-slate-400">${projectSistemas.substring(0, 30)}...</div></td>
                            <td class="p-3">${getStatusPill(p.statusId)}</td>
                            <td class="p-3">
                                <div class="w-full bg-slate-600 rounded-full h-2.5"><div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-2.5 rounded-full" style="width: ${p.progresso}%"></div></div>
                                <div class="text-right text-sm mt-1">${p.progresso}%</div>
                            </td>
                            <td class="p-3">
                               <button class="edit-btn" data-type="project" data-id="${p.id}"><i data-lucide="edit" class="text-cyan-400"></i></button>
                               <button class="delete-btn ml-2" data-type="project" data-id="${p.id}"><i data-lucide="trash-2" class="text-red-400"></i></button>
                            </td>
                        </tr>`;
                    tableBody.innerHTML += tableRowHTML;
                    
                    const responsaveisHTML = (p.equipe || []).map(assignment => {
                        const member = teamMembers.find(m => m.id === assignment.memberId);
                        if (!member) return '';
                        const assignedSistemas = (assignment.sistemasIds || []).map(sId => {
                            const sistema = sistemas.find(s => s.id === sId);
                            return `<span class="text-xs bg-slate-600 px-2 py-1 rounded-full whitespace-nowrap">${sistema?.nome || 'N/A'}</span>`;
                        }).join(' ');

                        return `<div class="flex items-center gap-2 text-sm">
                                    <div title="${member.nome}" class="w-7 h-7 rounded-full bg-blue-800 flex items-center justify-center text-xs font-bold ring-2 ring-slate-600 flex-shrink-0">${member.avatar}</div>
                                    <div class="flex flex-wrap gap-1">${assignedSistemas}</div>
                                </div>`;
                    }).join('');

                    projectCardsContainer.innerHTML += `<div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect flex flex-col justify-between relative">
                         <div>
                            <div class="flex justify-between items-start mb-4"><div class="pr-8"><h4 class="font-bold text-lg">${cliente?.nome}</h4><p class="text-sm text-slate-400">${projectSistemas}</p></div>${getStatusPill(p.statusId)}</div>
                            <div class="mb-4"><div class="text-right text-sm mt-1 mb-1">${p.progresso}%</div><div class="w-full bg-slate-600 rounded-full h-2.5"><div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-2.5 rounded-full" style="width: ${p.progresso}%"></div></div></div>
                            <div class="text-xs text-slate-400 flex justify-between mb-4"><span>In√≠cio: ${new Date(p.dataInicio).toLocaleDateString()}</span><span>Previs√£o: ${new Date(p.dataPrevisao).toLocaleDateString()}</span></div>
                         </div>
                        <div class="border-t border-slate-700 pt-4"><p class="text-sm text-slate-400 mb-2">Respons√°veis:</p><div class="space-y-3">${responsaveisHTML || '<p class="text-xs text-slate-500">Nenhum respons√°vel atribu√≠do.</p>'}</div></div>
                        <div class="absolute top-4 right-4 flex flex-col gap-2"><button class="edit-btn" data-type="project" data-id="${p.id}"><i data-lucide="edit" class="text-cyan-400"></i></button><button class="delete-btn" data-type="project" data-id="${p.id}"><i data-lucide="trash-2" class="text-red-400"></i></button></div>
                    </div>`;
                });
            }

            function renderTeam() {
                const container = document.getElementById('team-cards-container');
                if(!container) return;
                container.innerHTML = '';
                teamMembers.forEach(m => {
                    container.innerHTML += `<div class="bg-[#1E2A47] p-5 rounded-xl card-hover-effect text-center flex flex-col justify-between">
                        <div>
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 mx-auto flex items-center justify-center text-3xl font-bold mb-4">${m.avatar}</div>
                            <h4 class="font-bold text-lg">${m.nome}</h4><p class="text-blue-300 text-sm mb-3">${m.cargo}</p>
                            <div class="flex flex-wrap justify-center gap-2">${(m.skills || []).map(s => `<span class="bg-slate-700 text-slate-300 text-xs px-2.5 py-1 rounded-full">${s}</span>`).join('')}</div>
                        </div>
                        <div class="border-t border-slate-700 mt-4 pt-4 flex justify-center gap-4">
                            <button data-type="whatsapp" data-id="${m.id}" title="WhatsApp" class="text-green-400 hover:text-green-300"><i data-lucide="message-square"></i></button>
                            <a href="mailto:${m.email}" title="E-mail" class="text-sky-400 hover:text-sky-300"><i data-lucide="mail"></i></a>
                            <button class="edit-btn" data-type="team" data-id="${m.id}" title="Editar"><i data-lucide="edit" class="text-cyan-400 hover:text-cyan-300"></i></button>
                            <button class="delete-btn" data-type="team" data-id="${m.id}" title="Excluir"><i data-lucide="trash-2" class="text-red-400 hover:text-red-300"></i></button>
                        </div>
                    </div>`;
                });
            }

            function renderGenericTable(tbodyId, data, columns, type) {
                const tbody = document.getElementById(tbodyId);
                if (!tbody) return;
                tbody.innerHTML = '';
                data.forEach(item => {
                    const cells = columns.map(col => `<td class="p-3 ${col.class || ''}">${item[col.key]}</td>`).join('');
                    tbody.innerHTML += `<tr class="hover:bg-slate-700/50 border-b border-slate-700/50">${cells}
                        <td class="p-3 text-right">
                            <button class="edit-btn mr-2" data-type="${type}" data-id="${item.id}"><i data-lucide="edit" class="text-cyan-400"></i></button>
                            <button class="delete-btn" data-type="${type}" data-id="${item.id}"><i data-lucide="trash-2" class="text-red-400"></i></button>
                        </td></tr>`;
                });
            }
            function renderSistemas() { renderGenericTable('sistemas-table-body', sistemas, [{key:'nome', class:'font-semibold'}, {key:'tipo', class:'text-slate-300'}], 'sistema'); }
            function renderClientes() { renderGenericTable('clientes-table-body', clientes, [{key:'nome', class:'font-semibold'}, {key:'cidade', class:'text-slate-300'}, {key:'responsavel', class:'text-slate-300'}], 'cliente'); }
            function renderWhatsappMessages() { renderGenericTable('mensagens-table-body', whatsappMessages, [{key:'title', class:'font-semibold'}, {key:'text', class:'text-slate-300 truncate max-w-xs'}], 'mensagem'); }
            
            function renderStatuses() {
                const tbody = document.getElementById('status-table-body');
                if(!tbody) return;
                tbody.innerHTML = '';
                statuses.forEach(s => {
                    tbody.innerHTML += `<tr class="hover:bg-slate-700/50 border-b border-slate-700/50">
                        <td class="p-3 font-semibold">${s.text}</td>
                        <td class="p-3"><div class="w-8 h-8 rounded-full" style="background-color: ${s.color};"></div></td>
                        <td class="p-3 text-right">
                            <button class="edit-btn mr-2" data-type="status" data-id="${s.id}"><i data-lucide="edit" class="text-cyan-400"></i></button>
                            <button class="delete-btn" data-type="status" data-id="${s.id}"><i data-lucide="trash-2" class="text-red-400"></i></button>
                        </td></tr>`;
                });
            }
            
            function createOrUpdateChart(chartId, type, data, options) {
                const canvas = document.getElementById(chartId);
                if (!canvas) return; 
                const ctx = canvas.getContext('2d');
                if (chartInstances[chartId]) chartInstances[chartId].destroy();
                chartInstances[chartId] = new Chart(ctx, { type, data, options });
            }

            function renderReports() {
                const statusData = projects.reduce((acc, p) => { const s = statuses.find(st=>st.id===p.statusId)?.text || 'N/A'; acc[s] = (acc[s] || 0) + 1; return acc; }, {});
                const managerData = projects.reduce((acc, p) => { const m = teamMembers.find(tm=>tm.id===p.gerTec)?.nome || 'N/A'; acc[m] = (acc[m] || 0) + 1; return acc; }, {});
                const commercialManagerData = projects.reduce((acc, p) => { const m = teamMembers.find(tm=>tm.id===p.gerCom)?.nome || 'N/A'; acc[m] = (acc[m] || 0) + 1; return acc; }, {});

                const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#E2E8F0' } } } };
                const barChartOptions = { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { color: '#94A3B8' }, grid: { color: '#334155' } }, x: { ticks: { color: '#94A3B8' }, grid: { color: '#334155' } } } };

                createOrUpdateChart('statusChart', 'doughnut', { labels: Object.keys(statusData), datasets: [{ data: Object.values(statusData), backgroundColor: statuses.map(s=>s.color), borderColor: '#1E2A47', borderWidth: 4 }] }, chartOptions);
                createOrUpdateChart('managerChart', 'bar', { labels: Object.keys(managerData), datasets: [{ label: 'N¬∫ de Projetos', data: Object.values(managerData), backgroundColor: '#818CF8', borderRadius: 5 }] }, barChartOptions);
                createOrUpdateChart('commercialManagerChart', 'doughnut', { labels: Object.keys(commercialManagerData), datasets: [{ data: Object.values(commercialManagerData), backgroundColor: ['#F472B6', '#FBBF24', '#34D399', '#A78BFA'], borderRadius: 5 }] }, chartOptions);
            }

            function updateKPIs() {
                const kpiTempoMedio = document.getElementById('kpi-tempo-medio');
                if (!kpiTempoMedio) return;
                document.getElementById('kpi-projetos-ativos').textContent = projects.filter(p => p.statusId !== 'ST5').length;
                document.getElementById('kpi-projetos-risco').textContent = projects.filter(p => p.statusId === 'ST4').length;
                const concluidos = projects.filter(p => p.statusId === 'ST5');
                document.getElementById('kpi-taxa-sucesso').textContent = `${projects.length > 0 ? Math.round((concluidos.length / projects.length) * 100) : 0}%`;
                
                const duracoes = concluidos.map(p => (new Date(p.dataConclusao || p.dataPrevisao) - new Date(p.dataInicio)) / (1000 * 60 * 60 * 24));
                const tempoMedio = duracoes.length > 0 ? Math.round(duracoes.reduce((a,b) => a + b, 0) / duracoes.length) : 0;
                kpiTempoMedio.textContent = tempoMedio;
            }
            
            function renderIdeias() {
                const container = document.getElementById('ideias-container');
                if(!container) return;
                container.innerHTML = '';
                ideias.forEach(idea => {
                    container.innerHTML += `<div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                        <div class="flex justify-between items-start">
                           <div>
                             <h4 class="font-bold text-lg text-cyan-400">${idea.titulo}</h4>
                             <span class="text-xs bg-slate-700 px-2 py-1 rounded-full">${idea.categoria}</span>
                           </div>
                           <button class="flex items-center gap-1 text-slate-400 hover:text-white"><i data-lucide="thumbs-up" class="w-4 h-4"></i>${idea.upvotes || 0}</button>
                        </div>
                        <p class="text-slate-400 my-2 text-xs">Sugerido por: ${idea.author}</p>
                        <p class="text-slate-300 my-4 text-sm">${idea.descricao}</p>
                        <div class="text-right font-semibold">${idea.status}</div>
                    </div>`;
                });
            }
            
            function renderKB() {
                const container = document.getElementById('kb-container');
                if(!container) return;
                container.innerHTML = '';
                knowledgeBase.forEach(article => {
                    container.innerHTML += `<div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                        <h4 class="font-bold text-lg">${article.titulo}</h4>
                        <span class="text-xs bg-purple-500/50 text-purple-300 px-2 py-1 rounded-full">${article.categoria}</span>
                        <p class="text-slate-300 mt-4 text-sm">${article.conteudo}</p>
                    </div>`;
                });
            }
            
            function renderGamification() {
                const container = document.getElementById('gamification-container');
                if(!container) return;
                container.innerHTML = '';
                const nonManagers = teamMembers.filter(m => m.cargo && !m.cargo.toLowerCase().includes('gerente'));
                const scores = nonManagers.map(member => {
                    const completedProjects = projects.filter(p => p.equipe.some(e => e.memberId === member.id) && p.statusId === 'ST5');
                    const score = completedProjects.length * 10;
                    return { name: member.nome, score: score, avatar: member.avatar };
                });

                scores.sort((a, b) => b.score - a.score).forEach((item, index) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    container.innerHTML += `<div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-800">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg w-8 text-center">${medals[index] || index + 1}</span>
                            <div class="w-8 h-8 rounded-full bg-blue-800 flex items-center justify-center text-xs font-bold">${item.avatar}</div>
                            <span>${item.name}</span>
                        </div>
                        <span class="font-bold text-cyan-400">${item.score} pts</span>
                    </div>`;
                });
            }


            // --- L√ìGICA GERAL DE MODAIS ---
            function openGenericModal(modalElement) { modalElement.classList.remove('hidden'); setTimeout(() => modalElement.querySelector('div:first-child').classList.remove('scale-95', 'opacity-0'), 10); }
            function closeGenericModal(modalElement) { modalElement.querySelector('div:first-child').classList.add('scale-95', 'opacity-0'); setTimeout(() => modalElement.classList.add('hidden'), 300); }

            // --- L√ìGICA DO MODAL (PROJETO) ---
            const projectModal = document.getElementById('project-modal');
            document.getElementById('add-project-btn').addEventListener('click', () => {
                document.getElementById('project-form').reset();
                document.getElementById('projectId').value = '';
                document.getElementById('project-modal-title').textContent = 'Cadastrar Novo Projeto ‚ú®';
                document.getElementById('observacoes-container').innerHTML = '';
                populateManagerSelects(); 
                populateSistemasSelect('sistemas-select-add'); 
                populateClientesSelect(); 
                populateStatusSelect(); 
                populateTeamCheckboxes('equipe-checkboxes');
                renderSistemasTags('sistemas-tags-container', []);
                updateModuleAssignmentUI();
                renderKanban();
                openGenericModal(projectModal);
            });
            document.getElementById('close-modal-btn').addEventListener('click', () => closeGenericModal(projectModal));
            document.getElementById('cancel-btn').addEventListener('click', () => closeGenericModal(projectModal));

            document.getElementById('project-form').addEventListener('submit', e => {
                e.preventDefault();
                const id = document.getElementById('projectId').value;
                
                const equipe = [];
                document.querySelectorAll('#module-assignment-container select').forEach(select => {
                    const memberId = select.dataset.memberId;
                    const sistemasIds = Array.from(select.selectedOptions).map(opt => opt.value);
                    if (sistemasIds.length > 0) {
                        equipe.push({ memberId, sistemasIds });
                    }
                });

                const projectData = {
                    clienteId: document.getElementById('cliente-select').value, cidade: document.getElementById('cidade').value,
                    gerTec: document.getElementById('ger-tecnica').value, gerCom: document.getElementById('ger-comercial').value,
                    sistemasIds: Array.from(document.querySelectorAll('#sistemas-tags-container .sistema-tag')).map(tag => tag.dataset.id), 
                    progresso: parseInt(document.getElementById('progresso').value), statusId: document.getElementById('status-select').value,
                    dataInicio: document.getElementById('dataInicio').value, dataPrevisao: document.getElementById('dataPrevisao').value,
                    equipe: equipe
                };
                const novaObservacao = document.getElementById('nova-observacao').value.trim();

                if (id) {
                    const index = projects.findIndex(p => p.id == id);
                    if (novaObservacao) projects[index].observacoes.unshift({ date: new Date().toISOString(), text: novaObservacao });
                    projects[index] = { ...projects[index], ...projectData };
                } else {
                    const newProject = { ...projectData, id: Date.now(), observacoes: [], checklist: [{fase: "Levantamento", tasks: []}, {fase: "Execu√ß√£o", tasks: []}, {fase: "Homologa√ß√£o", tasks: []}, {fase: "Go Live", tasks: []}] };
                    if (novaObservacao) newProject.observacoes.unshift({ date: new Date().toISOString(), text: novaObservacao });
                    projects.unshift(newProject);
                }
                renderAll();
                closeGenericModal(projectModal);
            });
            
            function populateSelect(selectId, data, valueField, textField, selectedValue = '') {
                const select = document.getElementById(selectId);
                if(!select) return;
                select.innerHTML = '<option value="">Selecione...</option>';
                data.forEach(item => {
                    select.innerHTML += `<option value="${item[valueField]}" ${item[valueField] == selectedValue ? 'selected' : ''}>${item[textField]}</option>`;
                });
            }
            function populateManagerSelects(selectedGerTec = '', selectedGerCom = '') { 
                const gerentesTecnicos = teamMembers.filter(m => m.cargo && m.cargo.toLowerCase().includes('gerente t√©cn'));
                const gerentesComerciais = teamMembers.filter(m => m.cargo && m.cargo.toLowerCase().includes('gerente comer'));
                populateSelect('ger-tecnica', gerentesTecnicos, 'id', 'nome', selectedGerTec); 
                populateSelect('ger-comercial', gerentesComerciais, 'id', 'nome', selectedGerCom); 
            }
            function populateClientesSelect(selectedClienteId = '') { 
                const select = document.getElementById('cliente-select');
                if(!select) return;
                select.innerHTML = '<option value="">Selecione...</option>';
                clientes.forEach(item => {
                    select.innerHTML += `<option value="${item.id}" ${item.id == selectedClienteId ? 'selected' : ''}>${item.nome}</option>`;
                });
                select.addEventListener('change', (e) => {
                    const selectedClient = clientes.find(c => c.id === e.target.value);
                    if(selectedClient) {
                        document.getElementById('cidade').value = selectedClient.cidade;
                    }
                });
            }
            function populateStatusSelect(selectedStatusId = '') { populateSelect('status-select', statuses, 'id', 'text', selectedStatusId); }
            function populateSistemasSelect(selectId) { populateSelect(selectId, sistemas, 'id', 'nome');}

            function renderSistemasTags(containerId, sistemasIds = []) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '';
                const uniqueIds = [...new Set(sistemasIds)];

                uniqueIds.forEach(id => {
                    const sistema = sistemas.find(s => s.id === id);
                    if (!sistema) return;

                    const tag = document.createElement('span');
                    tag.className = 'sistema-tag flex items-center gap-2 bg-cyan-500/20 text-cyan-200 px-3 py-1 rounded-full text-sm';
                    tag.dataset.id = id;
                    tag.innerHTML = `<span>${sistema.nome}</span><button type="button" data-action="remove-sistema" class="leading-none"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                    container.appendChild(tag);
                });

                lucide.createIcons();
            }
            
            function populateTeamCheckboxes(containerId, selectedMemberIds = []) {
                const container = document.getElementById(containerId);
                if(!container) return;
                const nonManagers = teamMembers.filter(m => m.cargo && !m.cargo.toLowerCase().includes('gerente'));
                container.innerHTML = '';
                nonManagers.forEach(item => {
                    const checked = selectedMemberIds.includes(item.id) ? 'checked' : '';
                    container.innerHTML += `<label class="flex items-center gap-2 p-2 rounded hover:bg-slate-700 cursor-pointer"><input type="checkbox" value="${item.id}" ${checked} class="w-4 h-4 text-cyan-400 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500"><span>${item.nome}</span></label>`;
                });
                container.addEventListener('change', () => updateModuleAssignmentUI());
            }

            function updateModuleAssignmentUI(project = null) {
                const assignmentContainer = document.getElementById('module-assignment-container');
                if(!assignmentContainer) return;
                const selectedSistemasIds = Array.from(document.querySelectorAll('#sistemas-tags-container .sistema-tag')).map(tag => tag.dataset.id);
                const selectedTeamCheckboxes = document.querySelectorAll('#equipe-checkboxes input:checked');
                const existingAssignments = {};
                document.querySelectorAll('#module-assignment-container select[data-member-id]').forEach(select => {
                    existingAssignments[select.dataset.memberId] = Array.from(select.selectedOptions).map(opt => opt.value);
                });
                assignmentContainer.innerHTML = '';

                if (selectedSistemasIds.length === 0 || selectedTeamCheckboxes.length === 0) {
                    assignmentContainer.innerHTML = '<p class="text-slate-500 text-sm">Adicione sistemas e selecione membros da equipe para definir responsabilidades.</p>';
                    return;
                }

                selectedTeamCheckboxes.forEach(cb => {
                    const member = teamMembers.find(m => m.id === cb.value);
                    let selectedSystemsForMember = [];
                    if (project && project.equipe) {
                        const assignment = project.equipe.find(e => e.memberId === member.id);
                        if (assignment) selectedSystemsForMember = assignment.sistemasIds;
                    } else if (existingAssignments[member.id]) {
                        selectedSystemsForMember = existingAssignments[member.id].filter(id => selectedSistemasIds.includes(id));
                    }

                    const selectOptionsHTML = selectedSistemasIds.map(sId => {
                        const sistema = sistemas.find(s => s.id === sId);
                        const isSelected = selectedSystemsForMember.includes(sistema.id) ? 'selected' : '';
                        return `<option value="${sistema.id}" ${isSelected}>${sistema.nome}</option>`;
                    }).join('');

                    assignmentContainer.innerHTML += `
                        <div class="grid grid-cols-3 items-center gap-4">
                            <label class="text-slate-300 col-span-1">${member.nome}</label>
                            <select multiple data-member-id="${member.id}" class="col-span-2 bg-slate-700 p-2 rounded-lg border border-slate-600 h-24">
                                ${selectOptionsHTML}
                            </select>
                        </div>`;
                });
            }
            
            function renderKanban(project) {
                const container = document.getElementById('kanban-container');
                if(!container) return;
                container.innerHTML = '';
                if (!project || !project.checklist) return;

                project.checklist.forEach(column => {
                    const tasksHTML = column.tasks.map(task => `
                        <div class="bg-slate-800 p-3 rounded-lg mb-2 flex items-center justify-between">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" ${task.done ? 'checked' : ''} class="w-4 h-4 text-cyan-400 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500">
                                <span class="${task.done ? 'line-through text-slate-500' : ''}">${task.text}</span>
                            </label>
                        </div>
                    `).join('');

                    container.innerHTML += `
                        <div class="kanban-column">
                            <h5 class="font-bold mb-4 text-center">${column.fase}</h5>
                            <div class="space-y-2">${tasksHTML}</div>
                        </div>
                    `;
                });
            }

            // --- L√ìGICA DO MODAL UNIVERSAL (EQUIPE, SISTEMA, CLIENTE, STATUS) ---
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            document.getElementById('close-edit-modal-btn').addEventListener('click', () => closeGenericModal(editModal));
            document.getElementById('cancel-edit-btn').addEventListener('click', () => closeGenericModal(editModal));
            ['add-team-btn','add-sistema-btn','add-cliente-btn','add-status-btn', 'add-ideia-btn', 'add-kb-btn', 'add-mensagem-btn'].forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', () => openEditModalFor(id.split('-')[1], null, 'add'));
                }
            });


            const addSistemaToProjectBtn = document.getElementById('add-sistema-to-project-btn');
            if (addSistemaToProjectBtn) {
                addSistemaToProjectBtn.addEventListener('click', () => {
                    const select = document.getElementById('sistemas-select-add');
                    const selectedId = select?.value;
                    if (!selectedId) {
                        alert('Selecione um sistema para adicionar ao projeto.');
                        return;
                    }

                    const currentIds = Array.from(document.querySelectorAll('#sistemas-tags-container .sistema-tag')).map(tag => tag.dataset.id);
                    if (currentIds.includes(selectedId)) {
                        alert('Este sistema j√° foi adicionado ao projeto.');
                        return;
                    }

                    const updatedIds = [...currentIds, selectedId];
                    renderSistemasTags('sistemas-tags-container', updatedIds);
                    updateModuleAssignmentUI();
                    if (select) select.value = '';
                });
            }

            const sistemasTagsContainer = document.getElementById('sistemas-tags-container');
            if (sistemasTagsContainer) {
                sistemasTagsContainer.addEventListener('click', event => {
                    const removeBtn = event.target.closest('button[data-action="remove-sistema"]');
                    if (!removeBtn) return;
                    const tag = removeBtn.closest('.sistema-tag');
                    if (!tag) return;
                    tag.remove();
                    updateModuleAssignmentUI();
                });
            }



            ['import-team-btn', 'import-sistema-btn', 'import-client-btn'].forEach(id => {
                const button = document.getElementById(id);
                if (!button) return;
                button.addEventListener('click', () => {
                    importContext = button.dataset.importType || id.replace('import-', '').replace('-btn', '');
                    importInput.click();
                });
            });
            
            function openEditModalFor(type, id = null, mode = 'edit') {
                const modalTitle = document.getElementById('edit-modal-title');
                const formContent = document.getElementById('edit-form-content');
                
                editForm.dataset.type = type; editForm.dataset.id = id; editForm.dataset.mode = mode;
                formContent.innerHTML = '';

                let item = {};
                if (type === 'team') item = teamMembers.find(i => i.id === id) || {};
                if (type === 'sistema') item = sistemas.find(i => i.id === id) || {};
                if (type === 'cliente') item = clientes.find(i => i.id === id) || {};
                if (type === 'status') item = statuses.find(i => i.id === id) || {};
                if (type === 'ideia') item = ideias.find(i => i.id === id) || {};
                if (type === 'kb') item = knowledgeBase.find(i => i.id === id) || {};
                if (type === 'mensagem') item = whatsappMessages.find(i => i.id === id) || {};
                
                modalTitle.textContent = mode === 'add' ? `Adicionar ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Editar ${type.charAt(0).toUpperCase() + type.slice(1)}`;

                if (type === 'team') formContent.innerHTML = `<div><label>Nome</label><input name="nome" value="${item.nome || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Cargo</label><input name="cargo" value="${item.cargo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>E-mail</label><input type="email" name="email" value="${item.email || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Telefone (com DDI, ex: 5534...)</label><input type="tel" name="telefone" value="${item.telefone || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Habilidades (separadas por v√≠rgula)</label><input name="skills" value="${(item.skills || []).join(', ')}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div>`;
                if (type === 'sistema') formContent.innerHTML = `<div><label>Nome do Sistema</label><input name="nome" value="${item.nome || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Tipo</label><input name="tipo" value="${item.tipo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>`;
                if (type === 'cliente') formContent.innerHTML = `<div><label>Nome do Cliente</label><input name="nome" value="${item.nome || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Cidade</label><input name="cidade" value="${item.cidade || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Respons√°vel</label><input name="responsavel" value="${item.responsavel || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>`;
                if (type === 'status') formContent.innerHTML = `<div><label>Nome do Status</label><input name="text" value="${item.text || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Cor</label><input name="color" type="color" value="${item.color || '#64748B'}" class="w-full h-10 p-1 bg-slate-700 rounded-lg"></div>`;
                if (type === 'ideia') formContent.innerHTML = `<div><label>T√≠tulo da Ideia</label><input name="titulo" value="${item.titulo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Categoria</label><input name="categoria" value="${item.categoria || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Descri√ß√£o</label><textarea name="descricao" rows="4" class="w-full bg-slate-700 p-2.5 rounded-lg">${item.descricao || ''}</textarea></div><div><label>Status</label><select name="status" class="w-full bg-slate-700 p-2.5 rounded-lg"><option>Nova</option><option>Em An√°lise</option><option>Aprovada</option><option>Rejeitada</option></select></div>`;
                if (type === 'kb') formContent.innerHTML = `<div><label>T√≠tulo do Artigo</label><input name="titulo" value="${item.titulo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Categoria</label><input name="categoria" value="${item.categoria || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Conte√∫do</label><textarea name="conteudo" rows="6" class="w-full bg-slate-700 p-2.5 rounded-lg">${item.conteudo || ''}</textarea></div>`;
                if (type === 'mensagem') formContent.innerHTML = `<div><label>T√≠tulo da Mensagem</label><input name="title" value="${item.title || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Texto da Mensagem</label><textarea name="text" rows="4" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="Use [NOME] para o nome do destinat√°rio.">${item.text || ''}</textarea></div>`;

                openGenericModal(editModal);
            }
            
            editForm.addEventListener('submit', e => {
                e.preventDefault();
                const { type, id, mode } = e.currentTarget.dataset;
                const formData = new FormData(e.currentTarget);
                const data = Object.fromEntries(formData.entries());

                const updateOrAdd = (arr, itemData) => {
                    if (mode === 'edit') arr[arr.findIndex(i => i.id === id)] = { ...arr.find(i => i.id === id), ...itemData };
                    else arr.push({ ...itemData, id: type.charAt(0).toUpperCase() + Date.now().toString().slice(-4) });
                };

                if (type === 'team') { 
                    data.skills = data.skills.split(',').map(s=>s.trim()).filter(Boolean); 
                    data.avatar = generateAvatarInitials(data.nome);
                    data.telefone = data.telefone.replace(/\D/g,''); 
                    updateOrAdd(teamMembers, data); 
                }
                if (type === 'sistema') updateOrAdd(sistemas, data);
                if (type === 'cliente') updateOrAdd(clientes, data);
                if (type === 'status') updateOrAdd(statuses, data);
                if (type === 'ideia') updateOrAdd(ideias, data);
                if (type === 'kb') updateOrAdd(knowledgeBase, data);
                if (type === 'mensagem') updateOrAdd(whatsappMessages, data);

                renderAll();
                closeGenericModal(editModal);
            });

            // --- L√ìGICA DE EVENTOS (EDIT, DELETE) ---
            document.body.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const whatsappBtn = e.target.closest('button[data-type="whatsapp"]');

                if (editBtn) {
                    const { type, id } = editBtn.dataset;
                    if (type === 'project') {
                        const project = projects.find(p => p.id == id);
                        document.getElementById('project-modal-title').textContent = `Editar Projeto: ${clientes.find(c => c.id === project.clienteId)?.nome}`;
                        document.getElementById('projectId').value = project.id;
                        document.getElementById('cidade').value = project.cidade;
                        document.getElementById('progresso').value = project.progresso;
                        document.getElementById('dataInicio').value = project.dataInicio;
                        document.getElementById('dataPrevisao').value = project.dataPrevisao;
                        
                        const obsContainer = document.getElementById('observacoes-container');
                        obsContainer.innerHTML = project.observacoes.map(obs => `<div class="text-xs bg-slate-800 p-2 rounded"><p>${obs.text}</p><p class="text-slate-400 text-right">${new Date(obs.date).toLocaleString('pt-BR')}</p></div>`).join('') || '<p class="text-xs text-slate-500">Nenhuma observa√ß√£o.</p>';
                        
                        const projectTeamIds = project.equipe.map(e => e.memberId);
                        populateManagerSelects(project.gerTec, project.gerCom);
                        populateSistemasSelect('sistemas-select-add');
                        renderSistemasTags('sistemas-tags-container', project.sistemasIds);
                        populateClientesSelect(project.clienteId);
                        populateStatusSelect(project.statusId);
                        populateTeamCheckboxes('equipe-checkboxes', projectTeamIds);
                        updateModuleAssignmentUI(project);
                        renderKanban(project);
                        openGenericModal(projectModal);
                    } else {
                        openEditModalFor(type, id);
                    }
                }
                if(deleteBtn) {
                    const { type, id } = deleteBtn.dataset;
                    
                    const dataMap = {
                        project: { array: projects, getItemName: item => clientes.find(c => c.id === item.clienteId)?.nome || 'Projeto sem nome' },
                        sistema: { array: sistemas, getItemName: item => item.nome },
                        cliente: { array: clientes, getItemName: item => item.nome },
                        status:  { array: statuses, getItemName: item => item.text },
                        team:    { array: teamMembers, getItemName: item => item.nome },
                        mensagem: { array: whatsappMessages, getItemName: item => item.title },
                    };

                    const target = dataMap[type];
                    if (!target) return;

                    const item = target.array.find(i => i.id == id);
                    if (!item) return;

                    const itemName = target.getItemName(item);
                    
                    confirmAction('Confirmar Exclus√£o', `Tem certeza que deseja excluir "${itemName}"?`, () => {
                        const index = target.array.findIndex(i => i.id == id);
                        if (index > -1) {
                            target.array.splice(index, 1);
                        }
                        renderAll();
                    });
                }
                if(whatsappBtn){
                    const memberId = whatsappBtn.dataset.id;
                    const member = teamMembers.find(m => m.id === memberId);
                    if(member && member.telefone) {
                        openWhatsappModal(member);
                    } else {
                        alert('Telefone n√£o cadastrado para este membro da equipe.');
                    }
                }
            });
            
            // --- L√ìGICA DE NAVEGA√á√ÉO E TABS ---
            document.querySelectorAll('aside nav a').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetViewId = e.currentTarget.dataset.target;
                    document.querySelectorAll('main > div[data-view]').forEach(view => view.classList.add('hidden'));
                    document.getElementById(targetViewId).classList.remove('hidden');
                    document.querySelectorAll('aside nav a').forEach(l => l.classList.remove('gradient-bg'));
                    e.currentTarget.classList.add('gradient-bg');
                    if (targetViewId === 'relatorios-view') renderReports();
                    lucide.createIcons();
                });
            });

            document.querySelectorAll('.tab-link').forEach(tab => {
                tab.addEventListener('click', e => {
                    e.preventDefault();
                    const targetTabId = e.currentTarget.dataset.tab + '-tab';
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(targetTabId).classList.remove('hidden');
                    document.querySelectorAll('.tab-link').forEach(t => { t.classList.remove('text-cyan-400', 'border-cyan-400'); t.classList.add('text-slate-400', 'border-transparent'); });
                    e.currentTarget.classList.add('text-cyan-400', 'border-cyan-400');
                });
            });
            
            // --- L√ìGICA DE CONFIRMA√á√ÉO ---
            const confirmModal = document.getElementById('confirm-modal');
            function confirmAction(title, message, callback) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                openGenericModal(confirmModal);
                const okBtn = document.getElementById('confirm-ok-btn');
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                newOkBtn.addEventListener('click', () => { callback(); closeGenericModal(confirmModal); });
            }
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeGenericModal(confirmModal));
            
            // --- WHATSAPP MODAL ---
            const whatsappModal = document.getElementById('whatsapp-modal');
            document.getElementById('close-whatsapp-modal-btn').addEventListener('click', () => closeGenericModal(whatsappModal));
            
            function openWhatsappModal(member) {
                const list = document.getElementById('whatsapp-message-list');
                list.innerHTML = '';
                if (whatsappMessages.length === 0) {
                    list.innerHTML = '<p class="text-slate-400">Nenhuma mensagem personalizada cadastrada. Cadastre na tela "Mensagens".</p>';
                } else {
                    whatsappMessages.forEach(msg => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg';
                        btn.innerHTML = `<div class="font-bold">${msg.title}</div><p class="text-sm text-slate-400 truncate">${msg.text}</p>`;
                        btn.onclick = () => {
                            const messageText = msg.text.replace(/\[NOME\]/g, member.nome.split(' ')[0]);
                            const url = `https://wa.me/${member.telefone}?text=${encodeURIComponent(messageText)}`;
                            window.open(url, '_blank');
                            closeGenericModal(whatsappModal);
                        };
                        list.appendChild(btn);
                    });
                }
                openGenericModal(whatsappModal);
            }

            // --- L√ìGICA DE BACKUP, RESTORE E IMPORT ---
            document.getElementById('backup-btn').addEventListener('click', () => {
                const data = JSON.stringify({ projects, teamMembers, sistemas, clientes, statuses, ideias, knowledgeBase, whatsappMessages }, null, 2);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([data], { type: 'application/json' }));
                a.download = `sgi-ai-backup.json`;
                a.click();
            });
            document.getElementById('restore-btn').addEventListener('click', () => document.getElementById('restore-input').click());
            document.getElementById('restore-input').addEventListener('change', e => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = re => {
                    try {
                        const data = JSON.parse(re.target.result);
                        if (data.projects && data.teamMembers && data.sistemas && data.clientes && data.statuses) {
                            projects = data.projects; teamMembers = data.teamMembers; sistemas = data.sistemas; clientes = data.clientes; statuses = data.statuses;
                            ideias = data.ideias || []; knowledgeBase = data.knowledgeBase || []; whatsappMessages = data.whatsappMessages || [];
                            renderAll(); alert('Backup restaurado!');
                        } else { alert('Arquivo de backup inv√°lido.'); }
                    } catch (err) { alert('Erro ao ler o arquivo.'); }
                };
                reader.readAsText(file); e.target.value = '';
            });
            importInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (!importContext) {
                    event.target.value = '';
                    alert('Selecione o tipo de importa√ß√£o antes de escolher um arquivo.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' })
                            .filter(row => Array.isArray(row) && row.some(cell => String(cell ?? '').trim() !== ''));

                        const importedCount = handleImportData(importContext, rows);
                        if (importedCount > 0) {
                            renderAll();
                            alert(`${importedCount} registro${importedCount > 1 ? 's' : ''} importado${importedCount > 1 ? 's' : ''}!`);
                        } else {
                            alert('Nenhum registro v√°lido encontrado no arquivo selecionado.');
                        }
                    } catch (error) {
                        console.error('Erro ao importar arquivo:', error);
                        alert('N√£o foi poss√≠vel processar o arquivo informado.');
                    } finally {
                        importContext = null;
                        importInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // --- L√ìGICA DA IA ---
            function analyzeDataForAI() {
                const actionPointsContainer = document.getElementById('action-points-container');
                if (!actionPointsContainer) return;
                let insights = [];
                actionPointsContainer.innerHTML = '';

                projects.filter(p => p.statusId === 'ST4').forEach(p => insights.push(`<strong>Projeto em Risco:</strong> O projeto para <strong>${clientes.find(c=>c.id===p.clienteId)?.nome}</strong> precisa de aten√ß√£o imediata.`));
                projects.filter(p => p.progresso < 15 && p.statusId === 'ST2').forEach(p => insights.push(`<strong>In√≠cio Lento:</strong> Projeto <strong>${clientes.find(c=>c.id===p.clienteId)?.nome}</strong> tem apenas ${p.progresso}% de progresso.`));
                
                const managersInRisk = projects.filter(p => p.statusId === 'ST4').reduce((acc, p) => { acc[p.gerTec] = (acc[p.gerTec] || 0) + 1; return acc; }, {});
                Object.entries(managersInRisk).forEach(([managerId, count]) => {
                    if (count > 1) insights.push(`<strong>Sobrecarga de Risco:</strong> Gerente <strong>${teamMembers.find(m => m.id === managerId)?.nome}</strong> tem ${count} projetos em risco.`);
                });

                document.getElementById('ai-insight-text').textContent = insights.length ? insights[Math.floor(Math.random() * insights.length)].replace(/<[^>]*>/g, '') : "Nenhum insight cr√≠tico no momento. Bom trabalho!";
                
                if (insights.length) {
                    actionPointsContainer.innerHTML = insights.map(insight => `<div class="bg-slate-800/50 p-3 rounded-lg text-sm">${insight}</div>`).join('');
                } else {
                    actionPointsContainer.innerHTML = `<div class="text-center p-4"><i data-lucide="check-circle-2" class="mx-auto text-green-400 w-12 h-12"></i><p class="text-slate-400 mt-2">Tudo sob controle!</p></div>`;
                }
                lucide.createIcons();
            }


            // --- INICIALIZA√á√ÉO ---
            document.querySelector('[data-target="dashboard-view"]').click();
            renderAll();
            setInterval(analyzeDataForAI, 10000);
        });
    </script>
</body>
</html>

