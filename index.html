<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGI.AI - Gest√£o de Implanta√ß√£o Inteligente</title>
    
    <!-- Tailwind CSS para estiliza√ß√£o r√°pida e moderna -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Biblioteca de √çcones Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Biblioteca de Gr√°ficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <!-- Biblioteca para ler arquivos Excel (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Estilos personalizados para complementar o Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A192F; /* Azul noturno, cor prim√°ria */
            color: #E2E8F0; /* Texto claro */
        }

        /* Anima√ß√£o para o gradiente dos bot√µes e menus */
        .gradient-bg {
            background-image: linear-gradient(to right, #2DD4BF, #3B82F6);
            background-size: 200% auto;
            transition: background-position 0.5s ease;
        }

        .gradient-bg:hover {
            background-position: right center;
        }
        
        /* Efeito de brilho sutil nos cards */
        .card-hover-effect {
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border-color: #3B82F6;
        }

        /* Anima√ß√£o para o "Insight da IA" */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .ai-insight-glow {
            animation: fadeInOut 5s infinite;
        }

        /* Estilos para a barra de rolagem */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1E2A47; }
        ::-webkit-scrollbar-thumb {
            background-color: #3B82F6;
            border-radius: 10px;
            border: 2px solid #1E2A47;
        }

        .checkbox-container {
            max-height: 150px;
            overflow-y: auto;
            background-color: #0A192F;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 0.75rem;
        }

        /* Estilo para o Kanban/Checklist */
        .kanban-column {
            min-width: 300px;
            background-color: rgba(10, 25, 47, 0.5);
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .tab-link-active {
            color: #2DD4BF !important;
            border-color: #2DD4BF !important;
            background: linear-gradient(90deg, rgba(45, 212, 191, 0.12), rgba(59, 130, 246, 0.12));
            box-shadow: 0 12px 24px rgba(45, 212, 191, 0.18);
            border-radius: 0.5rem;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }
    </style>
</head>
<body class="flex antialiased">

    <!-- Sidebar / Menu Lateral -->
    <aside class="w-64 bg-[#112240] h-screen p-4 flex flex-col justify-between fixed">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <div class="p-2 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-lg">
                    <i data-lucide="sitemap" class="text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white leading-tight">SGI.<span class="text-cyan-400">AI</span></h1>

                    <p class="text-xs text-slate-300 tracking-wide">Vers√£o 1.6</p>
                    <p class="text-[10px] text-slate-400 tracking-wide">Sistema de Gest√£o de Implanta√ß√£o</p>

                </div>
            </div>
            <nav>
                <ul class="space-y-1">
                    <li><a href="#" data-target="dashboard-view" class="flex items-center gap-3 p-3 rounded-lg text-white font-semibold gradient-bg"><i data-lucide="layout-dashboard"></i> Dashboard</a></li>
                    <li><a href="#" data-target="projetos-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="folder-kanban"></i> Projetos</a></li>
                    <li><a href="#" data-target="cadastros-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="database"></i> Cadastros</a></li>
                    <li><a href="#" data-target="mensagens-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="message-circle"></i> Mensagens</a></li>
                    <li><a href="#" data-target="ideias-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="lightbulb"></i> Ideias</a></li>
                    <li><a href="#" data-target="relatorios-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="bar-chart-3"></i> Relat√≥rios</a></li>
                    <li><a href="#" data-target="configuracoes-view" class="flex items-center gap-3 p-3 rounded-lg hover:bg-slate-700 transition-colors"><i data-lucide="settings"></i> Configura√ß√µes</a></li>
                </ul>
            </nav>
        </div>

        <!-- Se√ß√£o do Insight da IA -->
        <div id="ai-insight-box" class="p-4 bg-slate-900 rounded-lg border border-cyan-400/30 ai-insight-glow">
            <div class="flex items-center gap-2 mb-2"><i data-lucide="lightbulb" class="text-cyan-400"></i><h3 class="font-semibold text-cyan-400">Insight da IA</h3></div>
            <p id="ai-insight-text" class="text-sm text-slate-300">Analisando dados...</p>
        </div>

    </aside>

    <!-- Conte√∫do Principal -->
    <main class="flex-1 ml-64 p-8 overflow-y-auto h-screen">
        
        <!-- ########## VIEW: DASHBOARD ########## -->
        <div id="dashboard-view" data-view>
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Dashboard Principal</h2><button id="add-project-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus-circle"></i> Novo Projeto</button></header>
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Projetos Ativos üöÄ</h3><i data-lucide="rocket" class="text-blue-400"></i></div>
                    <p id="kpi-projetos-ativos" class="text-4xl font-bold mt-2">0</p>
                </div>
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Projetos em Risco üò®</h3><i data-lucide="alert-triangle" class="text-yellow-400"></i></div>
                    <p id="kpi-projetos-risco" class="text-4xl font-bold mt-2">0</p>
                </div>
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Taxa de Sucesso üéØ</h3><i data-lucide="target" class="text-green-400"></i></div>
                    <p id="kpi-taxa-sucesso" class="text-4xl font-bold mt-2">0%</p>
                </div>
                 <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                    <div class="flex justify-between items-start"><h3 class="font-semibold text-slate-300">Tempo M√©dio (dias) ‚è≥</h3><i data-lucide="timer" class="text-cyan-400"></i></div>
                    <p id="kpi-tempo-medio" class="text-4xl font-bold mt-2">0</p>
                </div>
            </section>
            
            <section class="space-y-8">
                <div class="bg-[#1E2A47] p-6 rounded-xl">
                    <div class="flex items-center justify-between flex-wrap gap-4 mb-4">
                        <h3 class="text-xl font-bold">Alertas Contratuais</h3>
                        <p class="text-sm text-slate-400">Monitoramento inteligente de vig√™ncias, aditivos e limites financeiros.</p>
                    </div>
                    <div id="contract-alerts-container" class="space-y-4"></div>
                </div>
                <div class="bg-[#1E2A47] p-6 rounded-xl">
                    <h3 class="text-xl font-bold mb-4">Acompanhamento de Implanta√ß√µes</h3>
                    <div id="projects-blocks-container" class="grid gap-4 lg:gap-6 md:grid-cols-2 2xl:grid-cols-3"></div>
                </div>
                <div class="bg-[#1E2A47] p-6 rounded-xl">
                    <h3 class="text-xl font-bold mb-2 flex items-center gap-2"><i data-lucide="settings-2" class="text-cyan-400"></i> Gest√£o R√°pida</h3>
                    <p class="text-slate-400 text-sm mb-4">Acesse e gerencie cadastros essenciais diretamente do dashboard.</p>
                    <div class="space-y-3" id="dashboard-shortcuts">
                        <button data-dashboard-shortcut data-target-view="cadastros-view" data-target-tab="equipes" class="w-full flex items-center justify-between bg-slate-700/60 hover:bg-slate-600 text-left px-4 py-3 rounded-lg transition-colors">
                            <span class="flex items-center gap-2"><i data-lucide="users"></i> Equipes</span>
                            <i data-lucide="arrow-up-right"></i>
                        </button>
                        <button data-dashboard-shortcut data-target-view="cadastros-view" data-target-tab="sistemas" class="w-full flex items-center justify-between bg-slate-700/60 hover:bg-slate-600 text-left px-4 py-3 rounded-lg transition-colors">
                            <span class="flex items-center gap-2"><i data-lucide="cpu"></i> Sistemas</span>
                            <i data-lucide="arrow-up-right"></i>
                        </button>
                        <button data-dashboard-shortcut data-target-view="cadastros-view" data-target-tab="clientes" class="w-full flex items-center justify-between bg-slate-700/60 hover:bg-slate-600 text-left px-4 py-3 rounded-lg transition-colors">
                            <span class="flex items-center gap-2"><i data-lucide="building-2"></i> Clientes</span>
                            <i data-lucide="arrow-up-right"></i>
                        </button>
                        <button data-dashboard-shortcut data-target-view="mensagens-view" data-action="trigger-button" data-target-button="add-mensagem-btn" class="w-full flex items-center justify-between bg-slate-700/60 hover:bg-slate-600 text-left px-4 py-3 rounded-lg transition-colors">
                            <span class="flex items-center gap-2"><i data-lucide="message-circle"></i> Mensagens Personalizadas</span>
                            <i data-lucide="arrow-up-right"></i>
                        </button>
                        <button data-dashboard-shortcut data-target-view="dashboard-view" data-action="trigger-button" data-target-button="add-project-btn" class="w-full flex items-center justify-between bg-slate-700/60 hover:bg-slate-600 text-left px-4 py-3 rounded-lg transition-colors">
                            <span class="flex items-center gap-2"><i data-lucide="folder-plus"></i> Novo Projeto</span>
                            <i data-lucide="arrow-up-right"></i>
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <!-- ########## VIEW: PROJETOS ########## -->
        <div id="projetos-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Gerenciamento de Projetos üìÇ</h2></header>
            <section id="project-cards-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></section>
        </div>

        <!-- ########## VIEW: IDEIAS ########## -->
        <div id="ideias-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Banco de Ideias üí°</h2><button id="add-ideia-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Nova Ideia</button></header>
            <section id="ideias-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></section>
        </div>

        <!-- ########## VIEW: MENSAGENS ########## -->
        <div id="mensagens-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Mensagens Personalizadas üí¨</h2><button id="add-mensagem-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Nova Mensagem</button></header>
            <section class="bg-[#1E2A47] p-6 rounded-xl mb-6">
                <div class="flex items-start justify-between gap-4 flex-wrap">
                    <div>
                        <h3 class="text-xl font-bold text-white mb-1">Sugest√µes prontas para sua equipe</h3>
                        <p class="text-sm text-slate-300 max-w-3xl">Escolha uma das mensagens recomendadas para iniciar conversas com o time. Ao enviar pelo WhatsApp, os marcadores <span class="font-semibold text-cyan-300">[NOME]</span> e <span class="font-semibold text-cyan-300">[EQUIPE]</span> ser√£o substitu√≠dos automaticamente pelo nome do colaborador e da equipe.</p>
                    </div>
                </div>
                <div id="message-suggestions" class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            </section>
            <section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">T√≠tulo</th><th class="p-3">Mensagem</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="mensagens-table-body"></tbody></table></section>
        </div>

        <!-- ########## VIEW: BASE DE CONHECIMENTO ########## -->
        <div id="kb-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Base de Conhecimento üìñ</h2><button id="add-kb-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Novo Artigo</button></header>
            <section id="kb-container" class="space-y-4"></section>
        </div>

        <!-- ########## VIEW: CADASTROS ########## -->
        <div id="cadastros-view" data-view class="hidden">
            <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Cadastros Gerais ‚öôÔ∏è</h2></header>
            <div class="mb-6 border-b border-slate-700"><nav class="flex space-x-4 md:space-x-8" aria-label="Tabs"><a href="#" data-tab="equipes" class="tab-link tab-link-active text-cyan-400 border-cyan-400 py-3 px-3 md:py-4 md:px-4 border-b-2 font-medium text-lg">Equipes</a><a href="#" data-tab="sistemas" class="tab-link text-slate-400 border-transparent hover:text-slate-200 py-3 px-3 md:py-4 md:px-4 border-b-2 font-medium text-lg">Sistemas</a><a href="#" data-tab="clientes" class="tab-link text-slate-400 border-transparent hover:text-slate-200 py-3 px-3 md:py-4 md:px-4 border-b-2 font-medium text-lg">Clientes</a><a href="#" data-tab="status" class="tab-link text-slate-400 border-transparent hover:text-slate-200 py-3 px-3 md:py-4 md:px-4 border-b-2 font-medium text-lg">Status</a></nav></div>

            <div id="equipes-tab" class="tab-content"><header class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4"><div class="flex flex-col lg:flex-row lg:items-center gap-3 w-full lg:w-auto"><h3 class="text-xl font-bold">Membros da Equipe</h3><div class="relative w-full lg:w-72"><input type="search" id="team-search-input" placeholder="Buscar por nome..." class="w-full bg-slate-800 border border-slate-700 rounded-lg py-2.5 px-3 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="Buscar membros da equipe"></div></div><div class="flex items-center gap-4 self-end lg:self-auto"><button id="import-team-btn" data-import-type="team" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="upload"></i> Importar</button><button id="add-team-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="user-plus"></i> Adicionar</button></div></header><section id="team-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></section></div>

            <div id="sistemas-tab" class="tab-content hidden"><div class="flex justify-end mb-4 gap-4"><button id="import-sistema-btn" data-import-type="sistema" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="upload"></i> Importar</button><button id="add-sistema-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Adicionar Sistema</button></div><section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">Nome do Sistema</th><th class="p-3">Tipo</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="sistemas-table-body"></tbody></table></section></div>
            <div id="clientes-tab" class="tab-content hidden"><div class="flex justify-end mb-4 gap-4"><button id="import-client-btn" data-import-type="cliente" class="bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="upload"></i> Importar</button><button id="add-cliente-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Adicionar Cliente</button></div><section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">Nome do Cliente</th><th class="p-3">Cidade</th><th class="p-3">Respons√°vel</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="clientes-table-body"></tbody></table></section></div>
            <div id="status-tab" class="tab-content hidden"><div class="flex justify-end mb-4"><button id="add-status-btn" class="gradient-bg text-white font-semibold py-2 px-4 rounded-lg flex items-center gap-2"><i data-lucide="plus"></i> Adicionar Status</button></div><section class="bg-[#1E2A47] p-6 rounded-xl"><table class="w-full text-left"><thead><tr class="border-b border-slate-700"><th class="p-3">Nome do Status</th><th class="p-3">Cor</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="status-table-body"></tbody></table></section></div>
        </div>
        <input type="file" id="import-input" class="hidden" accept=".csv, .xls, .xlsx">

        <!-- ########## VIEW: RELAT√ìRIOS ########## -->
        <div id="relatorios-view" data-view class="hidden">
             <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Relat√≥rios & An√°lises üìà</h2></header>
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect"><h3 class="font-bold text-lg mb-4 text-center">Projetos por Status</h3><div class="h-64 flex items-center justify-center"><canvas id="statusChart"></canvas></div></div>
                <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect"><h3 class="font-bold text-lg mb-4 text-center">Carga de Trabalho (Ger. T√©cnico)</h3><div class="h-72 flex items-center justify-center"><canvas id="managerChart"></canvas></div></div>
                 <div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect"><h3 class="font-bold text-lg mb-4 text-center">Carga de Trabalho (Ger. Comercial)</h3><div class="h-72 flex items-center justify-center"><canvas id="commercialManagerChart"></canvas></div></div>
            </section>
        </div>
        
        <!-- ########## VIEW: CONFIGURA√á√ïES ########## -->
        <div id="configuracoes-view" data-view class="hidden">
             <header class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Configura√ß√µes do Sistema üîß</h2></header>
            <section class="bg-[#1E2A47] p-8 rounded-xl space-y-8">
                <div>
                    <h3 class="text-xl font-bold mb-2">Backup e Restaura√ß√£o de Dados</h3><p class="text-slate-400 mb-6">Salve todos os dados ou restaure a partir de um backup.</p>
                    <div class="flex items-center gap-4"><button id="backup-btn" class="gradient-bg text-white font-semibold py-3 px-6 rounded-lg flex items-center gap-2"><i data-lucide="download-cloud"></i> Fazer Backup</button><button id="restore-btn" class="bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg flex items-center gap-2"><i data-lucide="upload-cloud"></i> Restaurar Backup</button></div>
                    <input type="file" id="restore-input" class="hidden" accept=".json">
                </div>
            </section>
        </div>
    </main>

    <!-- Modal para Adicionar/Editar Projeto -->
    <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center overflow-y-auto hidden z-50 p-4 pt-16">
        <div class="bg-[#1E2A47] p-6 md:p-8 rounded-xl w-full max-w-5xl lg:max-w-6xl 2xl:max-w-7xl max-h-[85vh] overflow-y-auto transform transition-all scale-95 opacity-0" id="project-modal-content">
            <div class="flex justify-between items-center mb-6"><h3 id="project-modal-title" class="text-2xl font-bold"></h3><button id="close-modal-btn" class="text-slate-400"><i data-lucide="x-circle"></i></button></div>
            <form id="project-form">
                <input type="hidden" id="projectId">
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <!-- Coluna 1: Dados & Sele√ß√µes -->
                    <div class="space-y-6 lg:col-span-3">
                        <div class="bg-slate-900/40 border border-slate-800/60 rounded-lg p-5 space-y-4">
                            <h4 class="text-lg font-semibold">Dados do Projeto</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block mb-2 text-sm" for="cliente-select">Cliente</label><select id="cliente-select" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                                <div><label class="block mb-2 text-sm" for="cidade">Cidade</label><input type="text" id="cidade" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>
                                <div><label class="block mb-2 text-sm" for="dataInicio">Data de In√≠cio</label><input type="date" id="dataInicio" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>
                                <div><label class="block mb-2 text-sm" for="dataPrevisao">Previs√£o de Conclus√£o</label><input type="date" id="dataPrevisao" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>
                                <div><label class="block mb-2 text-sm" for="ger-comercial">Ger. Comercial</label><select id="ger-comercial" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                                <div><label class="block mb-2 text-sm" for="ger-tecnica">Ger. T√©cnico</label><select id="ger-tecnica" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                                <div><label class="block mb-2 text-sm" for="status-select">Status</label><select id="status-select" class="w-full bg-slate-700 p-2.5 rounded-lg" required></select></div>
                                <div><label class="block mb-2 text-sm" for="progresso">Progresso (%)</label><input type="number" id="progresso" class="w-full bg-slate-700 p-2.5 rounded-lg" required min="0" max="100"></div>
                                <div><label class="block mb-2 text-sm" for="contrato-numero">N√∫mero do Contrato</label><input type="text" id="contrato-numero" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="Ex.: 123/2024"></div>
                                <div><label class="block mb-2 text-sm" for="contrato-vigencia">Descri√ß√£o da Vig√™ncia</label><input type="text" id="contrato-vigencia" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="Ex.: 12 meses"></div>
                                <div><label class="block mb-2 text-sm" for="contrato-valor">Valor do Contrato</label><input type="text" id="contrato-valor" inputmode="decimal" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="Ex.: 150000,00"></div>
                                <div><label class="block mb-2 text-sm" for="contrato-validade">Fim da Vig√™ncia (data)</label><input type="date" id="contrato-validade" class="w-full bg-slate-700 p-2.5 rounded-lg"></div>
                            </div>
                        </div>
                        <div class="bg-slate-900/40 border border-slate-800/60 rounded-lg p-5 space-y-3">
                            <div>
                                <label class="block mb-2 text-sm">Aditivos Contratuais</label>
                                <p class="text-xs text-slate-400">Registre valores, termos e validade de cada aditivo. Use o bot√£o abaixo para adicionar quantos forem necess√°rios.</p>
                            </div>
                            <div id="aditivos-container" class="space-y-3 bg-slate-950/40 border border-slate-800/60 rounded-lg p-4 min-h-[72px]"></div>
                            <button type="button" id="add-aditivo-btn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 transition-colors text-sm"><i data-lucide="plus"></i> Adicionar aditivo</button>
                        </div>
                        <div class="bg-slate-900/40 border border-slate-800/60 rounded-lg p-5 space-y-3">
                            <label class="block mb-2 text-sm" for="sistemas-select-add">Sistemas a Implantar</label>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <select id="sistemas-select-add" class="w-full bg-slate-700 p-2.5 rounded-lg"></select>
                                <button type="button" id="add-sistema-to-project-btn" class="bg-cyan-500 text-white p-2.5 rounded-lg sm:w-auto"><i data-lucide="plus"></i></button>
                            </div>
                            <div id="sistemas-tags-container" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="bg-slate-900/40 border border-slate-800/60 rounded-lg p-5 space-y-3">
                            <label class="block mb-2 text-sm">Equipe do Projeto</label>
                            <div id="equipe-checkboxes" class="checkbox-container space-y-2 bg-slate-950/40 border border-slate-800/60 rounded-lg p-4"></div>
                        </div>
                        <div class="bg-slate-900/40 border border-slate-800/60 rounded-lg p-5 space-y-3">
                            <label class="block mb-2 text-sm">Atribui√ß√£o de M√≥dulos</label>
                            <div id="module-assignment-container" class="space-y-4 bg-slate-950/40 border border-slate-800/60 p-4 rounded-lg min-h-[150px] checkbox-container"></div>
                        </div>
                    </div>
                    <!-- Coluna 2: Kanban/Checklist e Observa√ß√µes -->
                    <div class="space-y-6 lg:col-span-2">
                        <div class="bg-slate-900/40 border border-slate-800/60 rounded-lg p-5 space-y-4">
                            <div class="flex items-center justify-between gap-3 flex-wrap">
                                <h4 class="text-lg font-semibold">Checklist de Implanta√ß√£o (Kanban)</h4>
                                <span class="text-xs text-slate-400">Organize as atividades por fase.</span>
                            </div>
                            <div id="kanban-container" class="flex gap-4 overflow-x-auto pb-2"></div>
                        </div>
                        <div class="bg-slate-900/40 border border-slate-800/60 rounded-lg p-5 space-y-4">
                            <div>
                                <label class="block mb-2 text-sm">Observa√ß√µes</label>
                                <div id="observacoes-container" class="space-y-2 max-h-64 overflow-y-auto bg-slate-950/40 border border-slate-800/60 p-3 rounded-lg min-h-[140px]"></div>
                            </div>
                            <div>
                                <label class="block mb-2 text-sm" for="nova-observacao">Adicionar Nova Observa√ß√£o</label>
                                <textarea id="nova-observacao" rows="3" class="w-full bg-slate-700 p-2.5 rounded-lg min-h-[120px]" placeholder="Digite aqui o motivo de um atraso, problema ou provid√™ncia..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4"><button type="button" id="cancel-btn" class="bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button type="submit" class="gradient-bg font-semibold py-2 px-6 rounded-lg">Salvar Projeto</button></div>
            </form>
        </div>
    </div>

    <!-- Modal Universal (Add/Edit Equipe, Sistema, Cliente, Status, Ideia, KB, Mensagem) -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-start overflow-y-auto hidden z-50 p-4 pt-16">
        <div class="bg-[#1E2A47] p-8 rounded-xl w-full max-w-xl transform transition-all scale-95 opacity-0" id="edit-modal-content-wrapper">
            <div class="flex justify-between items-center mb-6"><h3 id="edit-modal-title" class="text-2xl font-bold"></h3><button id="close-edit-modal-btn" class="text-slate-400"><i data-lucide="x-circle"></i></button></div>
            <form id="edit-form">
                <div id="edit-form-content" class="space-y-4"></div>
                <div class="mt-8 flex justify-end gap-4"><button type="button" id="cancel-edit-btn" class="bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button type="submit" class="gradient-bg font-semibold py-2 px-6 rounded-lg">Salvar</button></div>
            </form>
        </div>
    </div>
    
    <!-- Modal de Mensagem WhatsApp -->
    <div id="whatsapp-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-[#1E2A47] p-8 rounded-xl w-full max-w-lg transform transition-all scale-95 opacity-0">
             <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">Selecionar Mensagem</h3><button id="close-whatsapp-modal-btn" class="text-slate-400"><i data-lucide="x-circle"></i></button></div>
             <div id="whatsapp-message-list" class="space-y-2 max-h-80 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center hidden z-50 p-4">
        <div class="bg-[#1E2A47] p-8 rounded-xl w-full max-w-md transform transition-all scale-95 opacity-0" id="confirm-modal-content">
            <h3 id="confirm-title" class="text-xl font-bold mb-4"></h3><p id="confirm-message" class="text-slate-300 mb-8"></p>
            <div class="flex justify-end gap-4"><button id="confirm-cancel-btn" class="bg-slate-600 font-semibold py-2 px-6 rounded-lg">Cancelar</button><button id="confirm-ok-btn" class="bg-red-600 font-semibold py-2 px-6 rounded-lg">Confirmar</button></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // --- DADOS DO SISTEMA ---
            let teamMembers = [];
            let sistemas = [];
            let clientes = [];
            const STORAGE_KEY = 'sgi-ai-data';
            const DEFAULT_STATUSES = [
                { id: "ST1", text: "Planejamento", color: "#64748B" }, { id: "ST2", text: "Execu√ß√£o", color: "#3B82F6" },
                { id: "ST3", text: "Homologa√ß√£o", color: "#A855F7" }, { id: "ST4", text: "Risco", color: "#EF4444" },
                { id: "ST5", text: "Conclu√≠do", color: "#22C55E" },
            ];
            let statuses = [...DEFAULT_STATUSES];
            let projects = [];
            let ideias = [];
            let knowledgeBase = [];
            let whatsappMessages = [];
            const searchableSelects = new Map();
            const normalizeText = (text) => typeof text === 'string' ? text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase() : '';
            const escapeHTML = (text) => typeof text === 'string' ? text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;') : '';
            let teamSearchTerm = '';
            const defaultMessageSuggestions = [
                {
                    id: 'suggestion-welcome',
                    title: 'Boas-vindas ao projeto',
                    text: 'Ol√° [NOME]! Bem-vindo(a) ao projeto. A equipe [EQUIPE] est√° pronta para apoiar voc√™ no que for preciso. Vamos juntos alcan√ßar os resultados planejados?'
                },
                {
                    id: 'suggestion-checkin',
                    title: 'Check-in semanal',
                    text: 'Oi [NOME], tudo bem? Passando para saber como est√£o as atividades dessa semana da equipe [EQUIPE]. Precisa de algum suporte extra?'
                },
                {
                    id: 'suggestion-recognition',
                    title: 'Reconhecimento de destaque',
                    text: 'Parab√©ns [NOME]! O desempenho da equipe [EQUIPE] est√° chamando aten√ß√£o. Continue assim, conte comigo para mantermos esse ritmo excelente.'
                },
                {
                    id: 'suggestion-reminder',
                    title: 'Lembrete de alinhamento',
                    text: 'Ol√° [NOME], lembrando que amanh√£ teremos nosso alinhamento da equipe [EQUIPE]. Se precisar ajustar algo na pauta √© s√≥ me avisar.'
                }
            ];
            let importContext = null;

            const importInput = document.getElementById('import-input');
            const teamSearchInput = document.getElementById('team-search-input');
            if (teamSearchInput) {
                teamSearchInput.addEventListener('input', event => {
                    teamSearchTerm = event.target.value || '';
                    renderTeam();
                });
            }

            const storageAvailable = (() => {
                try {
                    if (typeof localStorage === 'undefined') return false;
                    const testKey = '__sgi_ai_storage_test__';
                    localStorage.setItem(testKey, '1');
                    localStorage.removeItem(testKey);
                    return true;
                } catch (error) {
                    console.warn('Persist√™ncia local indispon√≠vel:', error);
                    return false;
                }
            })();

            function saveData() {
                if (!storageAvailable) return;
                try {
                    const payload = { projects, teamMembers, sistemas, clientes, statuses, ideias, knowledgeBase, whatsappMessages };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
                } catch (error) {
                    console.warn('N√£o foi poss√≠vel salvar os dados localmente.', error);
                }
            }

            function loadPersistedData() {
                if (!storageAvailable) return;
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (!stored) return;
                    const data = JSON.parse(stored);
                    if (Array.isArray(data.teamMembers)) teamMembers = data.teamMembers;
                    if (Array.isArray(data.sistemas)) sistemas = data.sistemas;
                    if (Array.isArray(data.clientes)) clientes = data.clientes;
                    if (Array.isArray(data.statuses)) statuses = data.statuses.length ? data.statuses : [...DEFAULT_STATUSES];
                    if (Array.isArray(data.projects)) projects = data.projects;
                    if (Array.isArray(data.ideias)) ideias = data.ideias;
                    if (Array.isArray(data.knowledgeBase)) knowledgeBase = data.knowledgeBase;
                    if (Array.isArray(data.whatsappMessages)) whatsappMessages = data.whatsappMessages;
                } catch (error) {
                    console.warn('N√£o foi poss√≠vel carregar os dados salvos.', error);
                }
            }



            // --- L√ìGICA DE RENDERIZA√á√ÉO ---
            let chartInstances = {};

            function normalizeProjectAssignments(project) {
                if (!project || !Array.isArray(project.equipe)) return [];
                const projectSystems = Array.isArray(project.sistemasIds) ? project.sistemasIds.filter(Boolean) : [];

                return project.equipe.map(entry => {
                    if (!entry) return null;

                    if (typeof entry === 'string') {
                        return { memberId: entry, sistemasIds: [] };
                    }

                    if (typeof entry === 'object') {
                        const memberId = entry.memberId || entry.id || entry.member || entry.colaboradorId;
                        let sistemasIds = [];

                        if (Array.isArray(entry.sistemasIds)) {
                            sistemasIds = entry.sistemasIds.filter(Boolean);
                        } else if (Array.isArray(entry.sistemas)) {
                            sistemasIds = entry.sistemas.filter(Boolean);
                        } else if (Array.isArray(entry.modulos)) {
                            sistemasIds = entry.modulos.filter(Boolean);
                        } else if (entry.sistemaId) {
                            sistemasIds = [entry.sistemaId];
                        }

                        const validIds = sistemasIds.filter(id => projectSystems.includes(id) || sistemas.some(s => s.id === id));
                        return memberId ? { memberId, sistemasIds: Array.from(new Set(validIds)) } : null;
                    }

                    return null;
                }).filter(Boolean);
            }

            function normalizeProjectAditivos(project) {
                const result = [];
                const rawAditivos = Array.isArray(project?.aditivos) ? project.aditivos : [];

                rawAditivos.forEach(item => {
                    if (!item || typeof item !== 'object') return;
                    const id = item.id || generateUniqueId('ADT');
                    const descricao = sanitizeText(item.descricao || item.nome || item.termo || '');
                    const valor = parseCurrencyToNumber(item.valor || item.valorTotal || item.valorAditivo || 0);
                    const validade = sanitizeText(item.validade || item.vencimento || item.dataValidade || '');
                    result.push({ id, descricao, valor, validade });
                });

                if (result.length === 0) {
                    const descricao = sanitizeText(project?.aditivoTermo);
                    const validade = sanitizeText(project?.aditivoValidade);
                    const valor = parseCurrencyToNumber(project?.aditivoValor || 0);
                    if (descricao || validade || valor) {
                        result.push({
                            id: generateUniqueId('ADT'),
                            descricao: descricao || 'Aditivo contratual',
                            valor,
                            validade,
                        });
                    }
                }

                return result;
            }

            function normalizeProjectData(project) {
                if (!project || typeof project !== 'object') return project;
                const sistemasIds = Array.isArray(project.sistemasIds) ? project.sistemasIds.filter(Boolean) : [];
                const equipeRaw = Array.isArray(project.equipe) ? project.equipe : [];
                const observacoes = Array.isArray(project.observacoes) ? project.observacoes : [];
                const numeroContrato = sanitizeText(project.numeroContrato);
                const vigenciaDescricao = sanitizeText(project.vigenciaContrato || project.tempoVigencia || '');
                const vigenciaFim = project.vigenciaContratoFim || project.contratoValidade || '';
                const valorContrato = parseCurrencyToNumber(project.valorContrato);
                const aditivos = normalizeProjectAditivos(project);

                return {
                    ...project,
                    sistemasIds,
                    equipe: normalizeProjectAssignments({ ...project, sistemasIds, equipe: equipeRaw }),
                    observacoes,
                    numeroContrato,
                    vigenciaContrato: vigenciaDescricao,
                    vigenciaContratoFim: vigenciaFim,
                    valorContrato,
                    aditivos,
                };
            }

            function isModuleWithinSkills(member, sistema) {
                if (!sistema) return false;
                const skills = Array.isArray(member?.skills) ? member.skills.filter(Boolean) : [];
                if (skills.length === 0) return true;
                const sistemaName = normalizeComparisonText(sistema.nome);
                return skills.some(skill => sistemaName.includes(normalizeComparisonText(skill)));
            }

            function formatModuleBadge(sistemaId, member = null) {
                const sistema = sistemas.find(s => s.id === sistemaId);
                if (!sistema) return '';
                const compatible = member ? isModuleWithinSkills(member, sistema) : true;
                const baseClasses = 'text-xs px-2 py-1 rounded-full break-words leading-tight';
                const styleClasses = compatible ? 'bg-slate-600 text-slate-200' : 'bg-amber-500/20 text-amber-200 border border-amber-400/30';
                const label = compatible ? sistema.nome : `${sistema.nome} (*)`;
                return `<span class="${baseClasses} ${styleClasses}">${label}</span>`;
            }

            function getStatusPill(statusId) {
                 const status = statuses.find(s => s.id === statusId) || { text: 'N/A', color: '#808080' };
                const emojis = { Planejamento: '‚è≥', Execu√ß√£o: 'üü°', Homologa√ß√£o: 'üü†', Risco: '‚ùó', Conclu√≠do: '‚úÖ' };
                return `<span style="background-color:${status.color}40; color:${status.color}" class="py-1 px-3 rounded-full text-sm font-semibold">${status.text} ${emojis[status.text] || ''}</span>`;
            }
            
            function generateAvatarInitials(name) {
                if (!name || typeof name !== 'string') return '??';
                const parts = name.trim().split(' ').filter(Boolean);
                if (parts.length > 1) {
                    return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
                } else if (parts.length === 1) {
                    return parts[0].substring(0, 2).toUpperCase();
                }
                return '??';
            }

            function generateUniqueId(prefix) {
                return `${prefix}${Date.now().toString(36)}${Math.random().toString(36).slice(2, 6)}`;
            }

            function fixEncodingIssues(text) {
                if (!text) return '';
                const cleaned = text.replace(/\uFEFF/g, '');
                const needsFix = /[√É√Ç√ä√î√ï√£√µ√¢√™√¥]/.test(cleaned);
                if (!needsFix) {
                    return cleaned;
                }
                try {
                    if (typeof TextDecoder !== 'undefined') {
                        const bytes = Uint8Array.from(cleaned.split('').map(char => char.charCodeAt(0)));
                        const decoded = new TextDecoder('utf-8').decode(bytes);
                        if (decoded && !/[√É√Ç]/.test(decoded) && !decoded.includes('\uFFFD')) {
                            return decoded;
                        }
                    }
                } catch (error) {
                    console.warn('Falha ao normalizar texto com TextDecoder:', error);

                }
                try {
                    if (typeof escape === 'function' && typeof decodeURIComponent === 'function') {
                        const decoded = decodeURIComponent(escape(cleaned));
                        if (decoded) return decoded;
                    }
                } catch (error) {
                    console.warn('Falha ao normalizar texto via escape/decodeURIComponent:', error);
                }

                return cleaned;
            }

            function sanitizeText(value) {
                if (value === undefined || value === null) return '';
                const text = String(value).trim();
                return fixEncodingIssues(text);
            }

            function normalizeComparisonText(value) {
                return (value || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
            }

            function normalizeNumericString(value) {
                if (value === undefined || value === null || value === '') return '';
                if (typeof value === 'number' && Number.isFinite(value)) {
                    return Math.round(value).toString();
                }
                const text = sanitizeText(value);
                if (!text) return '';
                const numericValue = Number(text.replace(',', '.'));
                if (!Number.isNaN(numericValue)) {
                    return Math.round(numericValue).toString();
                }
                return text.replace(/\D/g, '');
            }

            const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

            function parseCurrencyToNumber(value) {
                if (typeof value === 'number' && Number.isFinite(value)) return value;
                const text = sanitizeText(value);
                if (!text) return 0;
                const normalized = text
                    .replace(/[^0-9,.-]/g, '')
                    .replace(/\.(?=\d{3}(?:\D|$))/g, '')
                    .replace(',', '.');
                const parsed = Number(normalized);
                return Number.isFinite(parsed) ? parsed : 0;
            }

            function formatCurrency(value, { fallback = 'N√£o informado', allowZero = false } = {}) {
                const numericValue = parseCurrencyToNumber(value);
                if (!allowZero && numericValue === 0) {
                    return fallback;
                }
                return currencyFormatter.format(numericValue || 0);
            }

            function describeDiffInDays(diffDays) {
                const absDays = Math.abs(diffDays);
                if (absDays === 0) return 'hoje';
                return `${absDays} dia${absDays === 1 ? '' : 's'}`;
            }

            function getDueStatus(dateString, thresholdDays = 30) {
                if (!dateString) return null;
                const date = new Date(dateString);
                if (Number.isNaN(date.getTime())) {
                    return { status: 'invalid', label: 'Data inv√°lida', formattedDate: '', diffDays: null };
                }
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dueDate = new Date(date);
                dueDate.setHours(0, 0, 0, 0);
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                const formattedDate = formatDateForDisplay(dateString);
                if (diffDays < 0) {
                    return {
                        status: 'overdue',
                        label: `Vencido h√° ${describeDiffInDays(diffDays)}`,
                        formattedDate,
                        diffDays,
                    };
                }
                if (diffDays <= thresholdDays) {
                    return {
                        status: 'upcoming',
                        label: `Vence em ${describeDiffInDays(diffDays)}`,
                        formattedDate,
                        diffDays,
                    };
                }
                return {
                    status: 'ok',
                    label: `Vence em ${describeDiffInDays(diffDays)}`,
                    formattedDate,
                    diffDays,
                };
            }

            function renderDueStatusBadge(status, emptyLabel = 'Sem data definida') {
                const baseClasses = 'inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full whitespace-nowrap';
                if (!status) {
                    return `<span class="${baseClasses} bg-slate-700/60 text-slate-300 border border-slate-600/40"><i data-lucide="help-circle" class="w-3.5 h-3.5"></i>${emptyLabel}</span>`;
                }
                let classes = 'bg-slate-700/60 text-slate-300 border border-slate-600/40';
                let icon = 'calendar';
                if (status.status === 'overdue') {
                    classes = 'bg-red-500/20 text-red-200 border border-red-500/40';
                    icon = 'alert-octagon';
                } else if (status.status === 'upcoming') {
                    classes = 'bg-amber-500/20 text-amber-200 border border-amber-500/40';
                    icon = 'alert-triangle';
                } else if (status.status === 'ok') {
                    classes = 'bg-emerald-500/10 text-emerald-200 border border-emerald-500/30';
                    icon = 'calendar-check';
                } else if (status.status === 'invalid') {
                    classes = 'bg-slate-700/60 text-slate-200 border border-slate-600/50';
                    icon = 'help-circle';
                }
                const suffix = status.formattedDate ? ` ‚Ä¢ ${status.formattedDate}` : '';
                return `<span class="${baseClasses} ${classes}"><i data-lucide="${icon}" class="w-3.5 h-3.5"></i>${status.label}${suffix}</span>`;
            }

            function mapRowsToObjects(rows, config, builder) {
                if (!Array.isArray(rows) || rows.length === 0) return [];
                const headerRowRaw = Array.isArray(rows[0]) ? rows[0] : [];
                const headerRow = headerRowRaw.map(cell => sanitizeText(cell).toLowerCase());
                const hasHeader = config.some(item => item.keys.some(key => headerRow.includes(key)));
                const dataRows = hasHeader ? rows.slice(1) : rows;

                return dataRows.map(row => {
                    if (!Array.isArray(row) || row.every(cell => sanitizeText(cell) === '')) return null;
                    const values = {};
                    config.forEach(item => {
                        let value = '';
                        if (hasHeader) {
                            const index = headerRow.findIndex(headerCell => item.keys.includes(headerCell));
                            if (index !== -1) {
                                value = row[index];
                            } else if (typeof item.defaultIndex === 'number' && item.defaultIndex < row.length) {
                                value = row[item.defaultIndex];
                            }
                        } else if (typeof item.defaultIndex === 'number' && item.defaultIndex < row.length) {
                            value = row[item.defaultIndex];
                        }
                        values[item.field] = value;
                    });
                    return builder(values, row, { hasHeader });
                }).filter(Boolean);
            }

            function handleImportData(type, rows) {
                if (!Array.isArray(rows) || rows.length === 0) return 0;
                let imported = [];

                if (type === 'team') {
                    const config = [
                        { field: 'nome', keys: ['nome', 'name'], defaultIndex: 0 },
                        { field: 'cargo', keys: ['fun√ß√£o', 'funcao', 'cargo', 'role'], defaultIndex: 1 },
                        { field: 'teamName', keys: ['equipe', 'time', 'squad', 'tribo'] },
                        { field: 'email', keys: ['e-mail', 'email'], defaultIndex: 2 },
                        { field: 'telefone', keys: ['telefone', 'phone', 'celular', 'whatsapp'], defaultIndex: 3 },
                    ];
                    imported = mapRowsToObjects(rows, config, values => {
                        const nome = sanitizeText(values.nome);
                        if (!nome) return null;
                        const cargoRaw = sanitizeText(values.cargo);
                        const cargo = cargoRaw || 'N√£o informado';
                        const email = sanitizeText(values.email);
                        const teamName = sanitizeText(values.teamName);
                        const telefone = normalizeNumericString(values.telefone);
                        return {
                            id: generateUniqueId('TM'),
                            nome,
                            cargo,
                            teamName,
                            email,
                            telefone,
                            avatar: generateAvatarInitials(nome),
                            skills: ['Importado'],
                        };
                    });
                    if (imported.length) {
                        teamMembers = imported;
                    }
                }

                if (type === 'sistema') {
                    const config = [
                        { field: 'sigla', keys: ['sigla', 'c√≥digo', 'codigo'], defaultIndex: 0 },
                        { field: 'nome', keys: ['sistema', 'nome', 'name'], defaultIndex: 1 },
                        { field: 'tipo', keys: ['web/desk', 'tipo', 'plataforma'], defaultIndex: 2 },
                    ];
                    imported = mapRowsToObjects(rows, config, values => {
                        const nome = sanitizeText(values.nome);
                        if (!nome) return null;
                        const sigla = sanitizeText(values.sigla);
                        const tipo = sanitizeText(values.tipo) || 'N√£o informado';
                        const idBase = sigla || nome;
                        const id = idBase ? idBase.replace(/\s+/g, '').toUpperCase() : generateUniqueId('SIS');
                        return { id, nome, tipo };
                    });
                    if (imported.length) {
                        sistemas = imported;
                    }
                }

                if (type === 'cliente') {
                    const config = [
                        { field: 'cnpj', keys: ['cnpj'], defaultIndex: 0 },
                        { field: 'nome', keys: ['cliente', 'nome', 'raz√£o social', 'razao social'], defaultIndex: 1 },
                        { field: 'cidade', keys: ['cidade', 'munic√≠pio', 'municipio', 'city'], defaultIndex: 2 },
                        { field: 'uf', keys: ['uf', 'estado', 'state'], defaultIndex: 3 },
                        { field: 'responsavel', keys: ['respons√°vel', 'responsavel', 'contato', 'respons√°vel comercial', 'responsavel comercial'] },
                    ];
                    imported = mapRowsToObjects(rows, config, values => {
                        const nome = sanitizeText(values.nome);
                        if (!nome) return null;
                        const cidadeBase = sanitizeText(values.cidade);
                        const uf = sanitizeText(values.uf);
                        const cidade = uf ? [cidadeBase, uf].filter(Boolean).join(' - ') : (cidadeBase || 'N√£o informado');
                        const responsavel = sanitizeText(values.responsavel) || 'N√£o informado';
                        const cnpj = normalizeNumericString(values.cnpj);
                        const id = cnpj ? `CL${cnpj}` : generateUniqueId('CL');
                        return { id, nome, cidade, responsavel, cnpj };
                    });
                    if (imported.length) {
                        clientes = imported;
                    }
                }

                return imported.length;
            }

            async function fetchSheetRows(path) {
                const response = await fetch(path, { cache: 'no-store' });
                if (!response.ok) throw new Error(`Falha ao carregar "${path}": ${response.status}`);
                const buffer = await response.arrayBuffer();
                const workbook = XLSX.read(buffer, { type: 'array', codepage: 65001 });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                return XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' })
                    .filter(row => Array.isArray(row) && row.some(cell => sanitizeText(cell) !== ''));
            }

            async function loadSampleCSVsIfNeeded() {
                const sources = [
                    { path: 'Equipe.csv', type: 'team', hasData: () => teamMembers.length > 0 },
                    { path: 'Sistemas.csv', type: 'sistema', hasData: () => sistemas.length > 0 },
                    { path: 'cliente.csv', type: 'cliente', hasData: () => clientes.length > 0 },
                ];

                for (const source of sources) {
                    if (source.hasData()) continue;
                    try {
                        const rows = await fetchSheetRows(source.path);
                        if (rows.length) handleImportData(source.type, rows);
                    } catch (error) {
                        console.warn(`N√£o foi poss√≠vel carregar o arquivo "${source.path}" automaticamente.`, error);
                    }
                }
            }

            async function loadInitialBackupData() {
                try {
                    const response = await fetch('sgi-ai-backup.json', { cache: 'no-store' });
                    if (!response.ok) return;
                    const data = await response.json();

                    if (!teamMembers.length && Array.isArray(data.teamMembers) && data.teamMembers.length) {
                        teamMembers = data.teamMembers.map(member => ({
                            ...member,
                            avatar: member.avatar || generateAvatarInitials(member.nome),
                            skills: Array.isArray(member.skills) ? member.skills.filter(Boolean) : [],
                            telefone: normalizeNumericString(member.telefone),
                        }));
                    }

                    if (!sistemas.length && Array.isArray(data.sistemas) && data.sistemas.length) {
                        sistemas = data.sistemas.map(sistema => ({
                            ...sistema,
                            id: sanitizeText(sistema.id) || generateUniqueId('SIS'),
                            nome: sanitizeText(sistema.nome) || 'Sistema sem nome',
                            tipo: sanitizeText(sistema.tipo) || 'N√£o informado',
                        }));
                    }

                    if (!clientes.length && Array.isArray(data.clientes) && data.clientes.length) {
                        clientes = data.clientes.map(cliente => ({
                            ...cliente,
                            id: sanitizeText(cliente.id) || generateUniqueId('CL'),
                            nome: sanitizeText(cliente.nome) || 'Cliente sem nome',
                            cidade: sanitizeText(cliente.cidade) || 'N√£o informado',
                            responsavel: sanitizeText(cliente.responsavel) || 'N√£o informado',
                        }));
                    }

                    if (!statuses.length && Array.isArray(data.statuses) && data.statuses.length) {
                        statuses = data.statuses.map(status => ({
                            ...status,
                            id: sanitizeText(status.id) || generateUniqueId('ST'),
                            text: sanitizeText(status.text) || 'Status',
                            color: sanitizeText(status.color) || '#64748B',
                        }));
                    }

                    if (!projects.length && Array.isArray(data.projects) && data.projects.length) {
                        projects = data.projects.map(project => ({
                            ...project,
                            sistemasIds: Array.isArray(project.sistemasIds) ? project.sistemasIds.filter(Boolean) : [],
                            equipe: Array.isArray(project.equipe) ? project.equipe : [],
                            observacoes: Array.isArray(project.observacoes) ? project.observacoes : [],
                        }));
                    }

                    if (!ideias.length && Array.isArray(data.ideias)) {
                        ideias = data.ideias;
                    }
                    if (!knowledgeBase.length && Array.isArray(data.knowledgeBase)) {
                        knowledgeBase = data.knowledgeBase;
                    }
                    if (!whatsappMessages.length && Array.isArray(data.whatsappMessages)) {
                        whatsappMessages = data.whatsappMessages;
                    }
                } catch (error) {
                    console.warn('N√£o foi poss√≠vel carregar o backup inicial de dados.', error);
                }
            }

            function ensureProjectsHaveAssignmentsStructure() {
                projects = projects.map(project => normalizeProjectData(project));
            }

            function renderMessageSuggestions() {
                const container = document.getElementById('message-suggestions');
                if (!container) return;
                container.innerHTML = '';

                defaultMessageSuggestions.forEach(suggestion => {
                    const alreadySaved = whatsappMessages.some(msg => msg.text.trim() === suggestion.text.trim());
                    const highlightedText = suggestion.text.replace(/\[(NOME|EQUIPE)\]/g, '<span class="text-cyan-300 font-semibold">[$1]</span>');
                    container.innerHTML += `
                        <div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 flex flex-col justify-between">
                            <div>
                                <h4 class="text-lg font-semibold text-white">${suggestion.title}</h4>
                                <p class="text-sm text-slate-300 mt-2 leading-relaxed">${highlightedText}</p>
                            </div>
                            <button data-action="use-suggestion" data-suggestion-id="${suggestion.id}" class="mt-4 self-start px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${alreadySaved ? 'bg-slate-700 text-slate-400 cursor-not-allowed' : 'gradient-bg text-white'}" ${alreadySaved ? 'disabled' : ''}>${alreadySaved ? 'Mensagem adicionada' : 'Adicionar √† lista personalizada'}</button>
                        </div>`;
                });
            }

            function handleSuggestionSelection(suggestionId) {
                const suggestion = defaultMessageSuggestions.find(item => item.id === suggestionId);
                if (!suggestion) return;
                const alreadySaved = whatsappMessages.some(msg => msg.text.trim() === suggestion.text.trim());
                if (alreadySaved) {
                    alert('Esta mensagem j√° est√° dispon√≠vel na sua lista personalizada.');
                    return;
                }
                whatsappMessages.push({ id: generateUniqueId('MSG'), title: suggestion.title, text: suggestion.text });
                saveData();
                renderWhatsappMessages();
                renderMessageSuggestions();
                lucide.createIcons();
                alert('Mensagem adicionada √† sua lista personalizada!');
            }

            function renderAll() {
                ensureProjectsHaveAssignmentsStructure();
                renderProjects();
                renderContractAlerts();
                renderTeam(); renderSistemas(); renderClientes(); renderStatuses();
                renderReports(); updateKPIs(); analyzeDataForAI(); renderIdeias(); renderKB();
                renderWhatsappMessages();

                renderMessageSuggestions();

                setupDashboardShortcuts();
                lucide.createIcons();
                saveData();
            }

            function renderProjects() {
                const projectsBlocksContainer = document.getElementById('projects-blocks-container');
                const projectCardsContainer = document.getElementById('project-cards-container');
                if (!projectsBlocksContainer || !projectCardsContainer) return;

                projectsBlocksContainer.innerHTML = ''; projectCardsContainer.innerHTML = '';
                projects.forEach(project => {
                    const normalized = normalizeProjectData(project);
                    const cliente = clientes.find(c => c.id === normalized.clienteId);
                    const projectId = normalized.id || project.id;
                    normalized.id = projectId;
                    const projectSystemsList = (normalized.sistemasIds || []).map(sId => sistemas.find(s => s.id === sId)?.nome).filter(Boolean);
                    const moduleSummaryBadges = ((normalized.sistemasIds || []).map(sId => formatModuleBadge(sId)).filter(Boolean).join(' ')) || '<span class="text-xs text-slate-500">Nenhum m√≥dulo cadastrado.</span>';
                    const gerenteComercial = teamMembers.find(tm => tm.id === normalized.gerCom)?.nome || 'N√£o atribu√≠do';
                    const gerenteTecnico = teamMembers.find(tm => tm.id === normalized.gerTec)?.nome || 'N√£o atribu√≠do';
                    const numeroContratoTexto = normalized.numeroContrato ? escapeHTML(normalized.numeroContrato) : 'N√£o informado';
                    const vigenciaDescricaoTexto = normalized.vigenciaContrato ? escapeHTML(normalized.vigenciaContrato) : 'N√£o informada';
                    const valorContratoTexto = normalized.valorContrato > 0 ? formatCurrency(normalized.valorContrato, { allowZero: true }) : 'N√£o informado';
                    const aditivos = Array.isArray(normalized.aditivos) ? normalized.aditivos : [];
                    const totalAditivosValor = aditivos.reduce((sum, item) => sum + parseCurrencyToNumber(item.valor), 0);
                    const totalAditivosTexto = totalAditivosValor > 0 ? formatCurrency(totalAditivosValor, { allowZero: true }) : 'Sem valores cadastrados';
                    const aditivoPercentualTexto = normalized.valorContrato > 0 && totalAditivosValor > 0 ? `${Math.round((totalAditivosValor / normalized.valorContrato) * 100)}% do contrato` : '';
                    const aditivoLimiteExcedido = normalized.valorContrato > 0 && totalAditivosValor > normalized.valorContrato * 0.25;
                    const vigenciaStatus = getDueStatus(normalized.vigenciaContratoFim);
                    const vigenciaBadge = renderDueStatusBadge(vigenciaStatus);
                    const dataInicioTexto = formatDateForDisplay(normalized.dataInicio) || 'N√£o informada';
                    const dataPrevisaoTexto = formatDateForDisplay(normalized.dataPrevisao) || 'N√£o informada';
                    const clienteNome = escapeHTML(cliente?.nome || 'Cliente n√£o identificado');
                    const cidadeTexto = escapeHTML(normalized.cidade || 'Cidade n√£o informada');
                    const statusPill = getStatusPill(normalized.statusId);
                    const sistemasLabel = escapeHTML(projectSystemsList.join(', ') || 'Sem sistemas selecionados');

                    const equipeEntries = (normalized.equipe || []).map(assignment => {
                        const member = teamMembers.find(m => m.id === assignment.memberId);
                        if (!member) return null;
                        const badgesHtml = (assignment.sistemasIds || []).map(sId => formatModuleBadge(sId, member)).filter(Boolean).join(' ') || '<span class="text-xs text-slate-500">Sem m√≥dulos atribu√≠dos.</span>';
                        return {
                            nome: escapeHTML(member.nome || 'Colaborador'),
                            badges: badgesHtml,
                        };
                    }).filter(Boolean);

                    const equipeResumo = equipeEntries.length
                        ? equipeEntries.map(entry => `<div class="space-y-1 bg-slate-900/40 border border-slate-700/60 rounded-md p-2"><div class="text-sm font-semibold text-slate-100">${entry.nome}</div><div class="flex flex-wrap gap-1">${entry.badges}</div></div>`).join('')
                        : '<p class="text-xs text-slate-500">Nenhum membro atribu√≠do.</p>';

                    const cardTeamResumo = equipeEntries.length
                        ? equipeEntries.map(entry => `<div><div class="font-semibold text-slate-100 text-sm">${entry.nome}</div><div class="flex flex-wrap gap-1 mt-1">${entry.badges}</div></div>`).join('')
                        : '<p class="text-xs text-slate-500">Nenhum respons√°vel atribu√≠do.</p>';


                    const aditivosListHTML = aditivos.length
                        ? aditivos.map(aditivo => {
                            const descricao = aditivo.descricao ? escapeHTML(aditivo.descricao) : 'Aditivo sem descri√ß√£o';
                            const valor = formatCurrency(aditivo.valor, { fallback: 'Sem valor informado', allowZero: false });
                            const status = renderDueStatusBadge(getDueStatus(aditivo.validade), 'Sem validade');
                            return `<div class="border border-slate-700 rounded-lg p-3 bg-slate-900/40 space-y-2"><div class="flex items-center justify-between gap-2"><span class="text-sm font-semibold text-slate-100">${descricao}</span>${status}</div><div><span class="text-xs uppercase text-slate-500 block">Valor</span><span class="text-sm text-slate-100">${valor}</span></div></div>`;
                        }).join('')
                        : '';

                    const aditivosCardContent = aditivos.length
                        ? `<div class="grid gap-3 md:grid-cols-2">${aditivosListHTML}</div>`
                        : '<p class="text-sm text-slate-500">Nenhum aditivo cadastrado at√© o momento.</p>';

                    const equipeSection = `<div class="bg-slate-900/40 border border-slate-700 rounded-lg p-3"><p class="text-xs uppercase tracking-wide text-slate-400">Equipe respons√°vel</p><div class="mt-2 space-y-2">${equipeResumo}</div></div>`;

                    const resumoInfoCards = `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 text-sm text-slate-300">
                            <div class="bg-slate-900/40 border border-slate-700/60 rounded-lg p-3 space-y-1">
                                <span class="text-xs uppercase text-slate-500 block">Contrato</span>
                                <span class="text-slate-100 font-semibold">N¬∫ ${numeroContratoTexto}</span>
                                <span class="text-xs text-slate-400">Valor: ${valorContratoTexto}</span>
                            </div>
                            <div class="bg-slate-900/40 border border-slate-700/60 rounded-lg p-3 space-y-1">
                                <span class="text-xs uppercase text-slate-500 block">Vig√™ncia</span>
                                <div class="flex flex-wrap gap-2 items-center mt-1">
                                    <span>${vigenciaDescricaoTexto}</span>
                                    ${vigenciaBadge}
                                </div>
                            </div>
                            <div class="bg-slate-900/40 border border-slate-700/60 rounded-lg p-3 space-y-1">
                                <span class="text-xs uppercase text-slate-500 block">Gest√£o</span>
                                <div class="flex flex-col gap-1 mt-1 text-slate-200">
                                    <span>Ger. Comercial: ${escapeHTML(gerenteComercial)}</span>
                                    <span>Ger. T√©cnico: ${escapeHTML(gerenteTecnico)}</span>
                                </div>
                            </div>
                            <div class="bg-slate-900/40 border border-slate-700/60 rounded-lg p-3 space-y-1">
                                <span class="text-xs uppercase text-slate-500 block">Sistemas</span>
                                <div class="flex flex-wrap gap-2 mt-1">${moduleSummaryBadges}</div>
                            </div>
                        </div>`;

                    const contratoCard = `<div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 space-y-3"><div class="flex items-center justify-between gap-2"><p class="text-xs uppercase tracking-wide text-slate-400">Resumo do Contrato</p>${aditivoLimiteExcedido ? '<span class="inline-flex items-center gap-1 text-xs font-semibold px-2 py-1 rounded-full bg-amber-500/20 text-amber-200 border border-amber-500/40"><i data-lucide="alert-triangle" class="w-3.5 h-3.5"></i>Limite 25% excedido</span>' : ''}</div><div class="space-y-2 text-sm text-slate-300"><div><span class="text-xs uppercase text-slate-500 block">N√∫mero</span><span class="text-slate-100 font-semibold">${numeroContratoTexto}</span></div><div><span class="text-xs uppercase text-slate-500 block">Valor</span><span class="text-slate-100 font-semibold">${valorContratoTexto}</span></div><div><span class="text-xs uppercase text-slate-500 block">Total dos aditivos</span><span class="text-slate-100 font-semibold">${totalAditivosTexto}</span>${aditivoPercentualTexto ? `<span class="block text-xs text-slate-400 mt-1">${aditivoPercentualTexto}</span>` : ''}</div></div>${aditivoLimiteExcedido ? '<div class="text-xs text-amber-200 bg-amber-500/10 border border-amber-500/40 rounded-md p-2 flex items-center gap-2"><i data-lucide="shield-alert" class="w-4 h-4"></i><span>O somat√≥rio dos aditivos ultrapassa 25% do valor contratual.</span></div>' : ''}</div>`;

                    const gestaoCard = `<div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 space-y-3"><p class="text-xs uppercase tracking-wide text-slate-400">Gest√£o do Projeto</p><div class="space-y-2 text-sm text-slate-300"><div><span class="text-xs uppercase text-slate-500 block">Ger. Comercial</span><span class="text-slate-100 font-semibold">${escapeHTML(gerenteComercial)}</span></div><div><span class="text-xs uppercase text-slate-500 block">Ger. T√©cnico</span><span class="text-slate-100 font-semibold">${escapeHTML(gerenteTecnico)}</span></div><div><span class="text-xs uppercase text-slate-500 block">Cidade</span><span class="text-slate-100 font-semibold">${cidadeTexto}</span></div></div><div><span class="text-xs uppercase text-slate-500 block mb-1">Status atual</span>${statusPill}</div></div>`;

                    const prazoCard = `<div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 space-y-3"><p class="text-xs uppercase tracking-wide text-slate-400">Prazos e Vig√™ncia</p><div class="grid grid-cols-1 gap-2 text-sm text-slate-300"><div><span class="text-xs uppercase text-slate-500 block">In√≠cio</span><span class="text-slate-100 font-semibold">${dataInicioTexto}</span></div><div><span class="text-xs uppercase text-slate-500 block">Previs√£o</span><span class="text-slate-100 font-semibold">${dataPrevisaoTexto}</span></div></div><div class="flex flex-wrap gap-2 items-center">${vigenciaBadge}</div><p class="text-xs text-slate-400">Descri√ß√£o: ${vigenciaDescricaoTexto}</p></div>`;

                    const aditivosCard = `<div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 space-y-3 xl:col-span-3"><div class="flex items-center justify-between gap-2"><p class="text-xs uppercase tracking-wide text-slate-400">Aditivos Contratuais</p><span class="text-xs text-slate-400">Total: ${aditivos.length}</span></div>${aditivosCardContent}</div>`;

                    const modulosCard = `<div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 space-y-3 xl:col-span-3"><div class="flex items-center justify-between gap-2"><p class="text-xs uppercase tracking-wide text-slate-400">M√≥dulos Selecionados</p><span class="text-xs text-slate-400">${projectSystemsList.length} m√≥dulo${projectSystemsList.length === 1 ? '' : 's'}</span></div><div class="flex flex-wrap gap-2">${moduleSummaryBadges}</div></div>`;

                    const detalhesHTML = `<div class="grid grid-cols-1 xl:grid-cols-3 gap-4">${contratoCard}${gestaoCard}${prazoCard}${aditivosCard}${modulosCard}</div>`;

                    const projectBlockHTML = `
                        <div class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 space-y-4 card-hover-effect">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <h4 class="text-lg font-semibold text-white">${clienteNome}</h4>
                                    <p class="text-sm text-slate-400">${cidadeTexto}</p>
                                </div>
                                ${statusPill}
                            </div>
                            <div>
                                <p class="text-xs uppercase tracking-wide text-slate-400 mb-2">Progresso</p>
                                <div class="flex items-center gap-3">
                                    <div class="flex-1 bg-slate-700 rounded-full h-2.5 overflow-hidden">
                                        <div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-2.5" style="width: ${normalized.progresso}%"></div>
                                    </div>
                                    <span class="text-sm font-semibold text-slate-100">${normalized.progresso}%</span>
                                </div>
                            </div>
                            ${equipeSection}
                            ${resumoInfoCards}
                            <details class="bg-slate-900/40 border border-slate-700/60 rounded-lg p-3">
                                <summary class="text-sm text-cyan-300 font-semibold cursor-pointer">Ver detalhes completos</summary>
                                <div class="mt-3 space-y-3">
                                    ${detalhesHTML}
                                </div>
                            </details>
                            <div class="flex justify-end gap-3 pt-3 border-t border-slate-700/60">
                                <button class="edit-btn" data-type="project" data-id="${projectId}"><i data-lucide="edit" class="text-cyan-400"></i></button>
                                <button class="delete-btn" data-type="project" data-id="${projectId}"><i data-lucide="trash-2" class="text-red-400"></i></button>
                            </div>
                        </div>`;
                    projectsBlocksContainer.innerHTML += projectBlockHTML;

                    const aditivosPreviewItems = aditivos.slice(0, 2).map(aditivo => {
                        const descricao = aditivo.descricao ? escapeHTML(aditivo.descricao) : 'Aditivo sem descri√ß√£o';
                        const valor = formatCurrency(aditivo.valor, { fallback: 'Sem valor informado', allowZero: false });
                        const status = getDueStatus(aditivo.validade);
                        let statusClass = 'text-slate-400';
                        if (status?.status === 'overdue') statusClass = 'text-red-300';
                        else if (status?.status === 'upcoming') statusClass = 'text-amber-200';
                        else if (status?.status === 'ok') statusClass = 'text-emerald-200';
                        const statusLabel = status ? status.label : 'Sem validade';
                        return `<div class="bg-slate-900/40 border border-slate-700/60 rounded-md p-2"><div class="flex items-center justify-between gap-2"><span class="text-sm font-semibold text-slate-100">${descricao}</span><span class="text-xs ${statusClass}">${statusLabel}</span></div><div class="text-xs text-slate-400 mt-1">${valor}</div></div>`;
                    }).join('');


                    const aditivosPreview = aditivos.length
                        ? `${aditivosPreviewItems}${aditivos.length > 2 ? `<p class="text-xs text-slate-400">+ ${aditivos.length - 2} aditivo(s) adicional(is)</p>` : ''}`
                        : '<p class="text-xs text-slate-500">Nenhum aditivo cadastrado.</p>';

                    projectCardsContainer.innerHTML += `<div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect flex flex-col justify-between relative"><div><div class="flex justify-between items-start mb-4 gap-4"><div class="pr-8"><h4 class="font-bold text-lg">${clienteNome}</h4><p class="text-sm text-slate-400">${sistemasLabel}</p></div>${statusPill}</div><div class="mb-4"><div class="text-right text-sm mt-1 mb-1">${normalized.progresso}%</div><div class="w-full bg-slate-600 rounded-full h-2.5"><div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-2.5 rounded-full" style="width: ${normalized.progresso}%"></div></div></div><div class="space-y-3 text-sm text-slate-300"><div><span class="text-xs uppercase text-slate-500 block">Contrato</span><div class="flex flex-wrap gap-x-4 gap-y-1 mt-1 text-slate-200"><span>N¬∫ ${numeroContratoTexto}</span><span>${valorContratoTexto}</span></div></div><div><span class="text-xs uppercase text-slate-500 block">Vig√™ncia</span><div class="flex flex-wrap gap-2 items-center mt-1"><span>${vigenciaDescricaoTexto}</span>${vigenciaBadge}</div></div><div><span class="text-xs uppercase text-slate-500 block">Aditivos (${aditivos.length})</span><div class="mt-1 space-y-2">${aditivosPreview}</div></div></div>${aditivoLimiteExcedido ? '<div class="mt-4 text-xs text-amber-200 bg-amber-500/10 border border-amber-400/30 rounded-lg p-3 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i><span>Total de aditivos ultrapassa 25% do valor contratual.</span></div>' : ''}</div><div class="border-t border-slate-700 pt-4 mt-4"><p class="text-sm text-slate-400 mb-2">Equipe respons√°vel</p><div class="space-y-3">${cardTeamResumo}</div></div><div class="absolute top-4 right-4 flex flex-col gap-2"><button class="edit-btn" data-type="project" data-id="${projectId}"><i data-lucide="edit" class="text-cyan-400"></i></button><button class="delete-btn" data-type="project" data-id="${projectId}"><i data-lucide="trash-2" class="text-red-400"></i></button></div></div>`;
                });

            }

            function renderContractAlerts() {
                const container = document.getElementById('contract-alerts-container');
                if (!container) return;

                const contractsOverdue = [];
                const contractsUpcoming = [];
                const aditivosOverdue = [];
                const aditivosUpcoming = [];
                const aditivosLimitExceeded = [];

                projects.forEach(project => {
                    const normalized = normalizeProjectData(project);
                    const cliente = clientes.find(c => c.id === normalized.clienteId);
                    const clienteNome = cliente ? cliente.nome : 'Projeto sem cliente';
                    const contractStatus = getDueStatus(normalized.vigenciaContratoFim);
                    const aditivos = Array.isArray(normalized.aditivos) ? normalized.aditivos : [];
                    const totalAditivosValor = aditivos.reduce((sum, item) => sum + parseCurrencyToNumber(item.valor), 0);

                    if (contractStatus?.status === 'overdue') {
                        contractsOverdue.push({ clienteNome, status: contractStatus });
                    } else if (contractStatus?.status === 'upcoming') {
                        contractsUpcoming.push({ clienteNome, status: contractStatus });
                    }

                    const valorContrato = normalized.valorContrato || 0;
                    if (valorContrato > 0 && totalAditivosValor > valorContrato * 0.25) {
                        const percentual = Math.round((totalAditivosValor / valorContrato) * 100);
                        aditivosLimitExceeded.push({ clienteNome, total: totalAditivosValor, valorContrato, percentual });
                    }

                    aditivos.forEach((aditivo, index) => {
                        const status = getDueStatus(aditivo.validade);
                        if (!status || status.status === 'invalid') return;
                        const descricao = aditivo.descricao ? aditivo.descricao : `Aditivo ${index + 1}`;
                        if (status.status === 'overdue') {
                            aditivosOverdue.push({ clienteNome, descricao, status });
                        } else if (status.status === 'upcoming') {
                            aditivosUpcoming.push({ clienteNome, descricao, status });
                        }
                    });
                });

                const summaryChips = [
                    { label: 'Contratos vencidos', count: contractsOverdue.length, className: 'bg-red-500/20 text-red-200 border border-red-500/40' },
                    { label: 'Contratos a vencer (30 dias)', count: contractsUpcoming.length, className: 'bg-amber-500/20 text-amber-200 border border-amber-500/40' },
                    { label: 'Aditivos vencidos', count: aditivosOverdue.length, className: 'bg-red-500/20 text-red-200 border border-red-500/40' },
                    { label: 'Aditivos a vencer', count: aditivosUpcoming.length, className: 'bg-amber-500/20 text-amber-200 border border-amber-500/40' },
                    { label: 'Aditivos acima de 25%', count: aditivosLimitExceeded.length, className: 'bg-cyan-500/20 text-cyan-200 border border-cyan-400/40' },
                ];

                container.innerHTML = `<div class="flex flex-wrap gap-2 mb-4">${summaryChips.map(chip => `<span class="px-3 py-1 rounded-full text-xs font-semibold border ${chip.className}">${chip.label}: ${chip.count}</span>`).join('')}</div>`;

                if (summaryChips.every(chip => chip.count === 0)) {
                    container.innerHTML += '<p class="text-sm text-emerald-200 bg-emerald-500/10 border border-emerald-500/30 rounded-lg px-4 py-3 flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i>Tudo em dia! Nenhum alerta no momento.</p>';
                    lucide.createIcons();
                    return;
                }

                const sections = [
                    { title: 'Contratos vencidos', items: contractsOverdue, icon: 'alert-octagon', textClass: 'text-red-200' },
                    { title: 'Contratos a vencer', items: contractsUpcoming, icon: 'alert-triangle', textClass: 'text-amber-200' },
                    { title: 'Aditivos vencidos', items: aditivosOverdue, icon: 'file-warning', textClass: 'text-red-200' },
                    { title: 'Aditivos a vencer', items: aditivosUpcoming, icon: 'calendar', textClass: 'text-amber-200' },
                    { title: 'Projetos acima do limite de aditivos', items: aditivosLimitExceeded, icon: 'scale', textClass: 'text-cyan-200' },
                ];

                sections.forEach(section => {
                    if (!section.items.length) return;
                    const itemsHtml = section.items.map(item => {
                        const header = `<div class="flex items-center justify-between gap-2"><span class="text-sm font-semibold text-slate-100">${escapeHTML(item.clienteNome)}</span>${item.status ? `<span class="text-xs ${section.textClass}">${item.status.label}${item.status.formattedDate ? ` ‚Ä¢ ${item.status.formattedDate}` : ''}</span>` : ''}</div>`;
                        const details = [];
                        if (item.descricao) {
                            details.push(`<p class="text-xs text-slate-400">${escapeHTML(item.descricao)}</p>`);
                        }
                        if (item.percentual) {
                            details.push(`<p class="text-xs text-slate-400">Total de aditivos: <span class="text-slate-200">${formatCurrency(item.total, { allowZero: true })}</span> (${item.percentual}% do contrato)</p>`);
                        }
                        return `<div class="bg-slate-900/40 border border-slate-700/60 rounded-md p-3 space-y-2">${header}${details.join('')}</div>`;
                    }).join('');
                    container.innerHTML += `<div class="border border-slate-700 rounded-lg p-4 space-y-3"><div class="flex items-center gap-2"><i data-lucide="${section.icon}" class="w-4 h-4 ${section.textClass}"></i><h4 class="text-sm font-semibold text-slate-100">${section.title}</h4></div>${itemsHtml}</div>`;

                });

                lucide.createIcons();
            }

            function renderTeam() {
                const container = document.getElementById('team-cards-container');
                if(!container) return;
                container.innerHTML = '';
                const normalizedTerm = normalizeText(teamSearchTerm.trim());
                const filteredMembers = normalizedTerm ? teamMembers.filter(m => normalizeText(m.nome).includes(normalizedTerm)) : [...teamMembers];

                if (filteredMembers.length === 0) {
                    const sanitizedTerm = escapeHTML(teamSearchTerm.trim());
                    const message = normalizedTerm
                        ? `Nenhum membro encontrado para <span class="text-slate-200 font-semibold">&ldquo;${sanitizedTerm}&rdquo;</span>.`
                        : 'Nenhum membro cadastrado at√© o momento.';
                    container.innerHTML = `<div class="col-span-full bg-[#1E2A47] p-6 rounded-xl text-center text-slate-400">${message}</div>`;
                    return;
                }

                filteredMembers.forEach(m => {
                    container.innerHTML += `<div class="bg-[#1E2A47] p-5 rounded-xl card-hover-effect text-center flex flex-col justify-between">
                        <div>
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 mx-auto flex items-center justify-center text-3xl font-bold mb-4">${m.avatar}</div>
                            <h4 class="font-bold text-lg">${m.nome}</h4>
                            <p class="text-blue-300 text-sm">${m.cargo}</p>
                            ${m.teamName ? `<p class=\"text-slate-400 text-xs uppercase tracking-wide mt-1\">Equipe ${m.teamName}</p>` : ''}
                            <div class="flex flex-wrap justify-center gap-2 mt-3">${(m.skills || []).map(s => `<span class="bg-slate-700 text-slate-300 text-xs px-2.5 py-1 rounded-full">${s}</span>`).join('')}</div>
                        </div>
                        <div class="border-t border-slate-700 mt-4 pt-4 flex justify-center gap-4">
                            <button data-type="whatsapp" data-id="${m.id}" title="WhatsApp" class="text-green-400 hover:text-green-300"><i data-lucide="message-square"></i></button>
                            <a href="mailto:${m.email}" title="E-mail" class="text-sky-400 hover:text-sky-300"><i data-lucide="mail"></i></a>
                            <button class="edit-btn" data-type="team" data-id="${m.id}" title="Editar"><i data-lucide="edit" class="text-cyan-400 hover:text-cyan-300"></i></button>
                            <button class="delete-btn" data-type="team" data-id="${m.id}" title="Excluir"><i data-lucide="trash-2" class="text-red-400 hover:text-red-300"></i></button>
                        </div>
                    </div>`;
                });
                lucide.createIcons();
            }

            function renderGenericTable(tbodyId, data, columns, type) {
                const tbody = document.getElementById(tbodyId);
                if (!tbody) return;
                tbody.innerHTML = '';
                data.forEach(item => {
                    const cells = columns.map(col => `<td class="p-3 ${col.class || ''}">${item[col.key]}</td>`).join('');
                    tbody.innerHTML += `<tr class="hover:bg-slate-700/50 border-b border-slate-700/50">${cells}
                        <td class="p-3 text-right">
                            <button class="edit-btn mr-2" data-type="${type}" data-id="${item.id}"><i data-lucide="edit" class="text-cyan-400"></i></button>
                            <button class="delete-btn" data-type="${type}" data-id="${item.id}"><i data-lucide="trash-2" class="text-red-400"></i></button>
                        </td></tr>`;
                });
            }
            function renderSistemas() { renderGenericTable('sistemas-table-body', sistemas, [{key:'nome', class:'font-semibold'}, {key:'tipo', class:'text-slate-300'}], 'sistema'); }
            function renderClientes() { renderGenericTable('clientes-table-body', clientes, [{key:'nome', class:'font-semibold'}, {key:'cidade', class:'text-slate-300'}, {key:'responsavel', class:'text-slate-300'}], 'cliente'); }
            function renderWhatsappMessages() { renderGenericTable('mensagens-table-body', whatsappMessages, [{key:'title', class:'font-semibold'}, {key:'text', class:'text-slate-300 truncate max-w-xs'}], 'mensagem'); }
            
            function renderStatuses() {
                const tbody = document.getElementById('status-table-body');
                if(!tbody) return;
                tbody.innerHTML = '';
                statuses.forEach(s => {
                    tbody.innerHTML += `<tr class="hover:bg-slate-700/50 border-b border-slate-700/50">
                        <td class="p-3 font-semibold">${s.text}</td>
                        <td class="p-3"><div class="w-8 h-8 rounded-full" style="background-color: ${s.color};"></div></td>
                        <td class="p-3 text-right">
                            <button class="edit-btn mr-2" data-type="status" data-id="${s.id}"><i data-lucide="edit" class="text-cyan-400"></i></button>
                            <button class="delete-btn" data-type="status" data-id="${s.id}"><i data-lucide="trash-2" class="text-red-400"></i></button>
                        </td></tr>`;
                });
            }
            
            function createOrUpdateChart(chartId, type, data, options) {
                const canvas = document.getElementById(chartId);
                if (!canvas) return; 
                const ctx = canvas.getContext('2d');
                if (chartInstances[chartId]) chartInstances[chartId].destroy();
                chartInstances[chartId] = new Chart(ctx, { type, data, options });
            }

            function renderReports() {
                const statusData = projects.reduce((acc, p) => { const s = statuses.find(st=>st.id===p.statusId)?.text || 'N/A'; acc[s] = (acc[s] || 0) + 1; return acc; }, {});
                const managerData = projects.reduce((acc, p) => { const m = teamMembers.find(tm=>tm.id===p.gerTec)?.nome || 'N/A'; acc[m] = (acc[m] || 0) + 1; return acc; }, {});
                const commercialManagerData = projects.reduce((acc, p) => { const m = teamMembers.find(tm=>tm.id===p.gerCom)?.nome || 'N/A'; acc[m] = (acc[m] || 0) + 1; return acc; }, {});

                const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#E2E8F0' } } } };
                const barChartOptions = { ...chartOptions, scales: { y: { beginAtZero: true, ticks: { color: '#94A3B8' }, grid: { color: '#334155' } }, x: { ticks: { color: '#94A3B8' }, grid: { color: '#334155' } } } };

                createOrUpdateChart('statusChart', 'doughnut', { labels: Object.keys(statusData), datasets: [{ data: Object.values(statusData), backgroundColor: statuses.map(s=>s.color), borderColor: '#1E2A47', borderWidth: 4 }] }, chartOptions);
                createOrUpdateChart('managerChart', 'bar', { labels: Object.keys(managerData), datasets: [{ label: 'N¬∫ de Projetos', data: Object.values(managerData), backgroundColor: '#818CF8', borderRadius: 5 }] }, barChartOptions);
                createOrUpdateChart('commercialManagerChart', 'doughnut', { labels: Object.keys(commercialManagerData), datasets: [{ data: Object.values(commercialManagerData), backgroundColor: ['#F472B6', '#FBBF24', '#34D399', '#A78BFA'], borderRadius: 5 }] }, chartOptions);
            }

            function updateKPIs() {
                const kpiTempoMedio = document.getElementById('kpi-tempo-medio');
                if (!kpiTempoMedio) return;
                document.getElementById('kpi-projetos-ativos').textContent = projects.filter(p => p.statusId !== 'ST5').length;
                document.getElementById('kpi-projetos-risco').textContent = projects.filter(p => p.statusId === 'ST4').length;
                const concluidos = projects.filter(p => p.statusId === 'ST5');
                document.getElementById('kpi-taxa-sucesso').textContent = `${projects.length > 0 ? Math.round((concluidos.length / projects.length) * 100) : 0}%`;
                
                const duracoes = concluidos.map(p => (new Date(p.dataConclusao || p.dataPrevisao) - new Date(p.dataInicio)) / (1000 * 60 * 60 * 24));
                const tempoMedio = duracoes.length > 0 ? Math.round(duracoes.reduce((a,b) => a + b, 0) / duracoes.length) : 0;
                kpiTempoMedio.textContent = tempoMedio;
            }
            
            function renderIdeias() {
                const container = document.getElementById('ideias-container');
                if(!container) return;
                container.innerHTML = '';
                ideias.forEach(idea => {
                    container.innerHTML += `<div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                        <div class="flex justify-between items-start">
                           <div>
                             <h4 class="font-bold text-lg text-cyan-400">${idea.titulo}</h4>
                             <span class="text-xs bg-slate-700 px-2 py-1 rounded-full">${idea.categoria}</span>
                           </div>
                           <button class="flex items-center gap-1 text-slate-400 hover:text-white"><i data-lucide="thumbs-up" class="w-4 h-4"></i>${idea.upvotes || 0}</button>
                        </div>
                        <p class="text-slate-400 my-2 text-xs">Sugerido por: ${idea.author}</p>
                        <p class="text-slate-300 my-4 text-sm">${idea.descricao}</p>
                        <div class="text-right font-semibold">${idea.status}</div>
                    </div>`;
                });
            }
            
            function renderKB() {
                const container = document.getElementById('kb-container');
                if(!container) return;
                container.innerHTML = '';
                knowledgeBase.forEach(article => {
                    container.innerHTML += `<div class="bg-[#1E2A47] p-6 rounded-xl card-hover-effect">
                        <h4 class="font-bold text-lg">${article.titulo}</h4>
                        <span class="text-xs bg-purple-500/50 text-purple-300 px-2 py-1 rounded-full">${article.categoria}</span>
                        <p class="text-slate-300 mt-4 text-sm">${article.conteudo}</p>
                    </div>`;
                });
            }
            
            // --- L√ìGICA GERAL DE MODAIS ---
            function openGenericModal(modalElement) { modalElement.classList.remove('hidden'); setTimeout(() => modalElement.querySelector('div:first-child').classList.remove('scale-95', 'opacity-0'), 10); }
            function closeGenericModal(modalElement) { modalElement.querySelector('div:first-child').classList.add('scale-95', 'opacity-0'); setTimeout(() => modalElement.classList.add('hidden'), 300); }

            // --- L√ìGICA DO MODAL (PROJETO) ---
            const projectModal = document.getElementById('project-modal');
            document.getElementById('add-project-btn').addEventListener('click', () => {
                document.getElementById('project-form').reset();
                document.getElementById('projectId').value = '';
                document.getElementById('project-modal-title').textContent = 'Cadastrar Novo Projeto ‚ú®';
                document.getElementById('observacoes-container').innerHTML = '';
                populateManagerSelects();
                populateSistemasSelect('sistemas-select-add');
                populateClientesSelect();
                populateStatusSelect();
                populateTeamCheckboxes('equipe-checkboxes');
                renderAditivosInputs([]);
                renderSistemasTags('sistemas-tags-container', []);
                const contratoValorInput = document.getElementById('contrato-valor');
                if (contratoValorInput) contratoValorInput.value = '';
                const contratoValidadeInput = document.getElementById('contrato-validade');
                if (contratoValidadeInput) contratoValidadeInput.value = '';
                updateModuleAssignmentUI();
                renderKanban();
                openGenericModal(projectModal);
            });
            document.getElementById('close-modal-btn').addEventListener('click', () => closeGenericModal(projectModal));
            document.getElementById('cancel-btn').addEventListener('click', () => closeGenericModal(projectModal));

            document.getElementById('project-form').addEventListener('submit', e => {
                e.preventDefault();
                const id = document.getElementById('projectId').value;
                
                const equipe = [];
                document.querySelectorAll('#module-assignment-container [data-member-assignment]').forEach(wrapper => {
                    const memberId = wrapper.dataset.memberId;

                    const sistemasIds = Array.from(wrapper.querySelectorAll('[data-role="assigned-chip"]')).map(chip => chip.dataset.sistemaId);

                    if (sistemasIds.length > 0) {
                        equipe.push({ memberId, sistemasIds });
                    }
                });

                const projectData = {

                    clienteId: document.getElementById('cliente-select').value,
                    cidade: document.getElementById('cidade').value,
                    gerTec: document.getElementById('ger-tecnica').value,
                    gerCom: document.getElementById('ger-comercial').value,
                    sistemasIds: Array.from(document.querySelectorAll('#sistemas-tags-container .sistema-tag')).map(tag => tag.dataset.id),
                    progresso: parseInt(document.getElementById('progresso').value),
                    statusId: document.getElementById('status-select').value,
                    dataInicio: document.getElementById('dataInicio').value,
                    dataPrevisao: document.getElementById('dataPrevisao').value,
                    numeroContrato: document.getElementById('contrato-numero').value.trim(),
                    vigenciaContrato: document.getElementById('contrato-vigencia').value.trim(),
                    valorContrato: parseCurrencyToNumber(document.getElementById('contrato-valor').value),
                    vigenciaContratoFim: document.getElementById('contrato-validade').value,
                    aditivos: collectAditivosFromForm(),
                    aditivoTermo: '',
                    aditivoValidade: '',

                    equipe: equipe
                };
                const novaObservacao = document.getElementById('nova-observacao').value.trim();

                if (id) {
                    const index = projects.findIndex(p => p.id == id);
                    if (novaObservacao) projects[index].observacoes.unshift({ date: new Date().toISOString(), text: novaObservacao });
                    projects[index] = { ...projects[index], ...projectData };
                } else {
                    const newProject = { ...projectData, id: Date.now(), observacoes: [], checklist: [{fase: "Levantamento", tasks: []}, {fase: "Execu√ß√£o", tasks: []}, {fase: "Homologa√ß√£o", tasks: []}, {fase: "Go Live", tasks: []}] };
                    if (novaObservacao) newProject.observacoes.unshift({ date: new Date().toISOString(), text: novaObservacao });
                    projects.unshift(newProject);
                }
                renderAll();
                closeGenericModal(projectModal);
            });
            
            function enhanceSelectWithSearch(selectId, placeholder = 'Digite para buscar...') {
                const select = document.getElementById(selectId);
                if (!select || select.dataset.searchEnhanced === 'true') return;

                const searchInput = document.createElement('input');
                searchInput.type = 'search';
                searchInput.placeholder = placeholder;
                searchInput.className = 'w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-3 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-400 mb-2';
                searchInput.dataset.role = 'select-search-input';
                searchInput.id = `${selectId}-search`;

                select.parentNode.insertBefore(searchInput, select);

                const relatedLabel = select.parentNode.querySelector('label');
                if (relatedLabel && !relatedLabel.getAttribute('for')) {
                    relatedLabel.setAttribute('for', searchInput.id);
                }

                const container = select.parentNode;
                if (container && !container.dataset.searchWrapperEnhanced) {
                    container.addEventListener('click', event => {
                        if (event.target === container) {
                            searchInput.focus();
                        }
                    });
                    container.dataset.searchWrapperEnhanced = 'true';
                }

                const filterOptions = () => {
                    const normalizedTerm = normalizeComparisonText(searchInput.value || '');
                    let firstMatchValue = '';

                    Array.from(select.options).forEach(option => {
                        if (!option.value) {
                            option.hidden = normalizedTerm.length > 0;
                            return;
                        }

                        const matches = normalizeComparisonText(option.text).includes(normalizedTerm);
                        option.hidden = normalizedTerm.length > 0 && !matches;

                        if (!firstMatchValue && matches) {
                            firstMatchValue = option.value;
                        }
                    });

                    if (normalizedTerm && firstMatchValue) {
                        if (select.value !== firstMatchValue) {
                            select.value = firstMatchValue;
                            select.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }

                    if (!normalizedTerm) {
                        Array.from(select.options).forEach(option => option.hidden = false);
                    }
                };

                searchInput.addEventListener('input', filterOptions);
                searchInput.addEventListener('keydown', event => {
                    if (event.key === 'Enter') event.preventDefault();
                });
                searchInput.addEventListener('focus', () => filterOptions());

                select.dataset.searchEnhanced = 'true';
                searchableSelects.set(selectId, { searchInput, filterOptions });
            }

            function populateSelect(selectId, data, valueField, textField, selectedValue = '') {
                const select = document.getElementById(selectId);
                if(!select) return;
                select.innerHTML = '<option value="">Selecione...</option>';
                data.forEach(item => {
                    select.innerHTML += `<option value="${item[valueField]}" ${item[valueField] == selectedValue ? 'selected' : ''}>${item[textField]}</option>`;
                });
                const enhancement = searchableSelects.get(selectId);
                if (enhancement) {
                    enhancement.filterOptions();
                }
            }
            function populateManagerSelects(selectedGerTec = '', selectedGerCom = '') {
                const gerentesTecnicos = teamMembers.filter(m => {
                    const cargo = normalizeComparisonText(m.cargo);
                    return cargo.includes('gerente tecn');
                });
                const gerentesComerciais = teamMembers.filter(m => {
                    const cargo = normalizeComparisonText(m.cargo);
                    return cargo.includes('gerente comer');
                });
                populateSelect('ger-tecnica', gerentesTecnicos, 'id', 'nome', selectedGerTec);
                populateSelect('ger-comercial', gerentesComerciais, 'id', 'nome', selectedGerCom);
            }
            function populateClientesSelect(selectedClienteId = '') {
                const select = document.getElementById('cliente-select');
                if(!select) return;
                select.innerHTML = '<option value="">Selecione...</option>';
                clientes.forEach(item => {
                    select.innerHTML += `<option value="${item.id}" ${item.id == selectedClienteId ? 'selected' : ''}>${item.nome}</option>`;
                });
                select.onchange = (e) => {
                    const selectedClient = clientes.find(c => c.id === e.target.value);
                    if(selectedClient) {
                        document.getElementById('cidade').value = selectedClient.cidade;
                    }
                };
                const enhancement = searchableSelects.get('cliente-select');
                if (enhancement) enhancement.filterOptions();
            }
            function populateStatusSelect(selectedStatusId = '') { populateSelect('status-select', statuses, 'id', 'text', selectedStatusId); }
            function populateSistemasSelect(selectId) { populateSelect(selectId, sistemas, 'id', 'nome');}

            function renderSistemasTags(containerId, sistemasIds = []) {
                const container = document.getElementById(containerId);
                if (!container) return;

                container.innerHTML = '';
                const uniqueIds = [...new Set(sistemasIds)];

                uniqueIds.forEach(id => {
                    const sistema = sistemas.find(s => s.id === id);
                    if (!sistema) return;

                    const tag = document.createElement('span');
                    tag.className = 'sistema-tag flex items-center gap-2 bg-cyan-500/20 text-cyan-200 px-3 py-1 rounded-full text-sm';
                    tag.dataset.id = id;
                    tag.innerHTML = `<span>${sistema.nome}</span><button type="button" data-action="remove-sistema" class="leading-none"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                    container.appendChild(tag);
                });

                lucide.createIcons();
            }

            const aditivosContainer = document.getElementById('aditivos-container');
            const addAditivoBtn = document.getElementById('add-aditivo-btn');

            function createAditivoRow(aditivo = {}) {
                if (!aditivosContainer) return null;
                const row = document.createElement('div');
                row.className = 'border border-slate-700 rounded-lg p-3 bg-slate-900/40 space-y-3';
                const aditivoId = aditivo.id || generateUniqueId('ADT');
                const descricao = aditivo.descricao ? escapeHTML(aditivo.descricao) : '';
                const valorNumerico = Number.isFinite(aditivo.valor) ? aditivo.valor : parseCurrencyToNumber(aditivo.valor);
                const valorTexto = valorNumerico ? valorNumerico.toString().replace('.', ',') : '';
                const validade = aditivo.validade || '';
                row.dataset.aditivoId = aditivoId;
                row.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div class="sm:col-span-2">
                            <label class="text-xs uppercase text-slate-400 block mb-1">Descri√ß√£o / Termo</label>
                            <input type="text" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200" data-role="aditivo-descricao" value="${descricao}">
                        </div>
                        <div>
                            <label class="text-xs uppercase text-slate-400 block mb-1">Valor (R$)</label>
                            <input type="text" inputmode="decimal" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200" data-role="aditivo-valor" value="${valorTexto}">
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <div class="flex-1 min-w-[180px]">
                            <label class="text-xs uppercase text-slate-400 block mb-1">Validade</label>
                            <input type="date" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200" data-role="aditivo-validade" value="${validade}">
                        </div>
                        <button type="button" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 text-sm" data-action="remove-aditivo"><i data-lucide="trash-2" class="w-4 h-4"></i>Remover</button>
                    </div>
                `;
                return row;
            }

            function renderAditivosInputs(aditivos = []) {
                if (!aditivosContainer) return;
                aditivosContainer.innerHTML = '';
                if (!Array.isArray(aditivos) || aditivos.length === 0) {
                    aditivosContainer.innerHTML = '<p class="text-sm text-slate-500" data-role="aditivo-empty">Nenhum aditivo cadastrado.</p>';
                    return;
                }
                aditivos.forEach(aditivo => {
                    const row = createAditivoRow(aditivo);
                    if (row) aditivosContainer.appendChild(row);
                });
                lucide.createIcons();
            }

            function collectAditivosFromForm() {
                if (!aditivosContainer) return [];
                return Array.from(aditivosContainer.querySelectorAll('[data-aditivo-id]')).map(wrapper => {
                    const id = wrapper.dataset.aditivoId || generateUniqueId('ADT');
                    const descricaoInput = wrapper.querySelector('[data-role="aditivo-descricao"]');
                    const valorInput = wrapper.querySelector('[data-role="aditivo-valor"]');
                    const validadeInput = wrapper.querySelector('[data-role="aditivo-validade"]');
                    const descricao = sanitizeText(descricaoInput?.value);
                    const valor = parseCurrencyToNumber(valorInput?.value || 0);
                    const validade = validadeInput?.value || '';
                    if (!descricao && !valor && !validade) return null;
                    return { id, descricao, valor, validade };
                }).filter(Boolean);
            }

            if (addAditivoBtn) {
                addAditivoBtn.addEventListener('click', () => {
                    if (!aditivosContainer) return;
                    const row = createAditivoRow({});
                    if (!row) return;
                    const empty = aditivosContainer.querySelector('[data-role="aditivo-empty"]');
                    if (empty) empty.remove();
                    aditivosContainer.appendChild(row);
                    lucide.createIcons();
                });
            }

            if (aditivosContainer && !aditivosContainer.dataset.listenerAttached) {
                aditivosContainer.addEventListener('click', event => {
                    const button = event.target.closest('[data-action="remove-aditivo"]');
                    if (!button) return;
                    const row = button.closest('[data-aditivo-id]');
                    if (row) row.remove();
                    if (!aditivosContainer.querySelector('[data-aditivo-id]')) {
                        aditivosContainer.innerHTML = '<p class="text-sm text-slate-500" data-role="aditivo-empty">Nenhum aditivo cadastrado.</p>';
                    }
                });
                aditivosContainer.dataset.listenerAttached = 'true';
            }
            
            function filterTeamCheckboxes(listContainer, term = '', emptyState = null) {
                if (!listContainer) return;
                const normalizedTerm = normalizeComparisonText(term || '');
                let visibleCount = 0;
                listContainer.querySelectorAll('label').forEach(label => {
                    const source = label.dataset.searchValue || '';
                    const matches = !normalizedTerm || source.includes(normalizedTerm);
                    label.classList.toggle('hidden', !matches);
                    if (matches) visibleCount++;
                });
                if (emptyState) {
                    emptyState.classList.toggle('hidden', visibleCount > 0);
                }
            }

            function populateTeamCheckboxes(containerId, selectedMemberIds = []) {
                const container = document.getElementById(containerId);
                if(!container) return;
                const nonManagers = teamMembers.filter(m => {
                    const cargo = normalizeComparisonText(m.cargo);
                    return !cargo.includes('gerente');
                });

                let searchInput = container.querySelector('input[data-role="team-search"]');
                let listContainer = container.querySelector('[data-role="team-list"]');
                let emptyState = container.querySelector('[data-role="team-empty"]');

                if (!listContainer) {
                    container.innerHTML = '';

                    const searchWrapper = document.createElement('div');
                    searchWrapper.className = 'mb-3';
                    searchInput = document.createElement('input');
                    searchInput.type = 'search';
                    searchInput.placeholder = 'Digite para buscar membro...';
                    searchInput.className = 'w-full bg-slate-800 border border-slate-700 rounded-lg py-2 px-3 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-cyan-400';
                    searchInput.dataset.role = 'team-search';
                    searchWrapper.appendChild(searchInput);
                    container.appendChild(searchWrapper);

                    listContainer = document.createElement('div');
                    listContainer.dataset.role = 'team-list';
                    listContainer.className = 'space-y-2 max-h-60 overflow-y-auto pr-1';
                    container.appendChild(listContainer);

                    emptyState = document.createElement('p');
                    emptyState.dataset.role = 'team-empty';
                    emptyState.className = 'text-sm text-slate-500 hidden';
                    emptyState.textContent = 'Nenhum membro encontrado.';
                    container.appendChild(emptyState);

                    searchInput.addEventListener('input', () => filterTeamCheckboxes(listContainer, searchInput.value, emptyState));

                    if (!container.dataset.changeHandlerAttached) {
                        listContainer.addEventListener('change', () => updateModuleAssignmentUI());
                        container.dataset.changeHandlerAttached = 'true';
                    }
                } else {
                    listContainer.innerHTML = '';
                }

                nonManagers.forEach(item => {
                    const wrapper = document.createElement('label');
                    wrapper.className = 'flex items-center gap-2 p-2 rounded hover:bg-slate-700 cursor-pointer';
                    wrapper.dataset.searchValue = normalizeComparisonText(item.nome);
                    wrapper.innerHTML = `<input type="checkbox" value="${item.id}" ${selectedMemberIds.includes(item.id) ? 'checked' : ''} class="w-4 h-4 text-cyan-400 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500"><span>${item.nome}</span>`;
                    listContainer.appendChild(wrapper);
                });

                filterTeamCheckboxes(listContainer, searchInput ? searchInput.value : '', emptyState);
            }

            [
                { id: 'cliente-select', placeholder: 'Digite para buscar o cliente...' },
                { id: 'ger-comercial', placeholder: 'Digite para buscar o gerente comercial...' },
                { id: 'ger-tecnica', placeholder: 'Digite para buscar o gerente t√©cnico...' },
                { id: 'sistemas-select-add', placeholder: 'Digite para buscar o sistema...' },
            ].forEach(({ id, placeholder }) => enhanceSelectWithSearch(id, placeholder));

            function formatAssignmentCountLabel(count) {
                if (!count) return 'Nenhum m√≥dulo selecionado';
                return `${count} m√≥dulo${count === 1 ? '' : 's'}`;
            }

            function formatDateForDisplay(value) {
                if (!value) return '';
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return '';
                return date.toLocaleDateString('pt-BR');
            }

            function refreshMemberAssignmentCount(wrapper) {
                if (!wrapper) return;
                const countSpan = wrapper.querySelector('[data-role="assignment-count"]');
                if (!countSpan) return;

                const total = wrapper.querySelectorAll('[data-role="assigned-chip"]').length;

                countSpan.textContent = formatAssignmentCountLabel(total);
            }

            function refreshAllMemberAssignmentCounts(container) {
                if (!container) return;
                container.querySelectorAll('[data-member-assignment]').forEach(wrapper => refreshMemberAssignmentCount(wrapper));
            }


            function getSelectedProjectSystemIds() {
                return Array.from(document.querySelectorAll('#sistemas-tags-container .sistema-tag')).map(tag => tag.dataset.id);
            }

            function ensureAssignedListHasContent(wrapper) {
                const list = wrapper.querySelector('[data-role="assigned-list"]');
                if (!list) return;
                if (list.querySelector('[data-role="assigned-chip"]')) {
                    const emptyState = list.querySelector('[data-role="empty-state"]');
                    if (emptyState) emptyState.remove();
                } else if (!list.querySelector('[data-role="empty-state"]')) {
                    const emptyMessage = document.createElement('span');
                    emptyMessage.dataset.role = 'empty-state';
                    emptyMessage.className = 'text-xs text-slate-500';
                    emptyMessage.textContent = 'Nenhum m√≥dulo atribu√≠do.';
                    list.appendChild(emptyMessage);
                }
            }

            function createModuleChipElement(sistemaId, member = null) {
                const sistema = sistemas.find(s => s.id === sistemaId);
                if (!sistema) return null;
                const compatible = member ? isModuleWithinSkills(member, sistema) : true;
                const chip = document.createElement('span');
                chip.dataset.role = 'assigned-chip';
                chip.dataset.sistemaId = sistemaId;
                chip.dataset.compatible = compatible ? 'true' : 'false';
                const baseClasses = 'sistema-chip flex items-center gap-2 px-3 py-1 rounded-full text-sm';
                chip.className = compatible ? `${baseClasses} bg-cyan-500/20 text-cyan-200` : `${baseClasses} bg-amber-500/20 text-amber-200 border border-amber-400/30`;
                const label = compatible ? sistema.nome : `${sistema.nome} (*)`;
                chip.innerHTML = `<span>${label}</span><button type="button" data-action="remove-member-module" class="leading-none"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                if (!compatible) {
                    chip.title = 'M√≥dulo fora das habilidades cadastradas para este membro.';
                }
                return chip;
            }

            function updateModulePickerOptions(wrapper) {
                if (!wrapper) return;
                const picker = wrapper.querySelector('select[data-role="module-picker"]');
                const hint = wrapper.querySelector('[data-role="available-hint"]');
                if (!picker) return;

                const assignedIds = Array.from(wrapper.querySelectorAll('[data-role="assigned-chip"]')).map(chip => chip.dataset.sistemaId);
                const memberId = wrapper.dataset.memberId;
                const member = teamMembers.find(m => m.id === memberId);
                const projectSystemIds = getSelectedProjectSystemIds();
                const availableIds = projectSystemIds.filter(id => !assignedIds.includes(id) && sistemas.some(s => s.id === id));
                let incompatibleCount = 0;

                picker.innerHTML = '<option value="">Adicionar m√≥dulo...</option>';
                availableIds.forEach(id => {
                    const sistema = sistemas.find(s => s.id === id);
                    if (!sistema) return;
                    const compatible = isModuleWithinSkills(member, sistema);
                    if (!compatible) incompatibleCount++;
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = compatible ? sistema.nome : `${sistema.nome} (*)`;
                    picker.appendChild(option);
                });

                picker.value = '';
                picker.disabled = availableIds.length === 0;
                picker.classList.toggle('opacity-50', availableIds.length === 0);
                if (hint) {
                    if (availableIds.length === 0) {
                        hint.textContent = 'Todos os m√≥dulos selecionados j√° foram atribu√≠dos para este membro.';
                        hint.classList.remove('hidden');
                    } else if (incompatibleCount > 0) {
                        hint.textContent = 'Op√ß√µes marcadas com (*) n√£o fazem parte das habilidades cadastradas.';
                        hint.classList.remove('hidden');
                    } else {
                        hint.classList.add('hidden');
                    }
                }
            }


            function updateModuleAssignmentUI(project = null) {
                const assignmentContainer = document.getElementById('module-assignment-container');
                if(!assignmentContainer) return;


                const selectedSistemasIds = getSelectedProjectSystemIds();
                const selectedTeamCheckboxes = Array.from(document.querySelectorAll('#equipe-checkboxes input:checked'));


                const existingAssignments = {};
                assignmentContainer.querySelectorAll('[data-member-assignment]').forEach(wrapper => {
                    const memberId = wrapper.dataset.memberId;

                    existingAssignments[memberId] = Array.from(wrapper.querySelectorAll('[data-role="assigned-chip"]')).map(chip => chip.dataset.sistemaId);

                });

                assignmentContainer.innerHTML = '';

                if (selectedTeamCheckboxes.length === 0) {
                    assignmentContainer.innerHTML = '<p class="text-slate-500 text-sm">Selecione membros da equipe para distribuir os m√≥dulos dispon√≠veis.</p>';
                    return;
                }

                if (selectedSistemasIds.length === 0) {
                    assignmentContainer.innerHTML = '<p class="text-slate-500 text-sm">Adicione sistemas ao projeto para escolher os m√≥dulos de cada membro.</p>';
                    return;
                }

                const projectAssignments = project ? normalizeProjectAssignments(project) : [];

                selectedTeamCheckboxes.forEach(cb => {
                    const member = teamMembers.find(m => m.id === cb.value);
                    if (!member) return;

                    let selectedSystemsForMember = [];
                    if (project) {
                        const assignment = projectAssignments.find(e => e.memberId === member.id);
                        if (assignment) selectedSystemsForMember = assignment.sistemasIds.filter(id => selectedSistemasIds.includes(id));
                    } else if (existingAssignments[member.id]) {
                        selectedSystemsForMember = existingAssignments[member.id].filter(id => selectedSistemasIds.includes(id));
                    }

                    selectedSystemsForMember = Array.from(new Set(selectedSystemsForMember)).filter(id => sistemas.some(s => s.id === id));

                    const wrapper = document.createElement('div');
                    wrapper.className = 'space-y-3 border border-slate-700 rounded-lg p-4';
                    wrapper.dataset.memberAssignment = 'true';
                    wrapper.dataset.memberId = member.id;

                    const header = document.createElement('div');
                    header.className = 'flex items-center justify-between gap-3 flex-wrap';
                    const memberInfo = document.createElement('div');
                    memberInfo.innerHTML = `<span class="text-slate-200 font-semibold">${member.nome}</span>${member.teamName ? `<div class="text-xs text-slate-500">Equipe ${member.teamName}</div>` : ''}`;
                    const countSpan = document.createElement('span');
                    countSpan.dataset.role = 'assignment-count';
                    countSpan.className = 'text-xs text-slate-400';
                    header.appendChild(memberInfo);
                    header.appendChild(countSpan);
                    wrapper.appendChild(header);

                    const assignedList = document.createElement('div');
                    assignedList.className = 'flex flex-wrap gap-2';
                    assignedList.dataset.role = 'assigned-list';
                    selectedSystemsForMember.forEach(id => {
                        const chip = createModuleChipElement(id, member);
                        if (chip) assignedList.appendChild(chip);
                    });
                    wrapper.appendChild(assignedList);
                    ensureAssignedListHasContent(wrapper);

                    const controls = document.createElement('div');
                    controls.className = 'flex flex-wrap gap-2 items-center';
                    controls.innerHTML = `<select data-role="module-picker" class="bg-slate-800 text-slate-200 rounded-lg p-2 flex-grow min-w-[200px]"></select><p data-role="available-hint" class="text-xs text-slate-500 hidden">Todos os m√≥dulos selecionados j√° foram atribu√≠dos para este membro.</p>`;
                    wrapper.appendChild(controls);

                    assignmentContainer.appendChild(wrapper);
                    refreshMemberAssignmentCount(wrapper);
                    updateModulePickerOptions(wrapper);
                });

                lucide.createIcons();

            }

            const moduleAssignmentContainer = document.getElementById('module-assignment-container');
            if (moduleAssignmentContainer && !moduleAssignmentContainer.dataset.listenerAttached) {
                moduleAssignmentContainer.addEventListener('change', event => {

                    if (event.target.matches('select[data-role="module-picker"]')) {
                        const select = event.target;
                        const value = select.value;
                        if (!value) return;
                        const wrapper = select.closest('[data-member-assignment]');
                        if (!wrapper) return;
                        const list = wrapper.querySelector('[data-role="assigned-list"]');
                        if (!list) return;
                        if (list.querySelector(`[data-role="assigned-chip"][data-sistema-id="${value}"]`)) {
                            select.value = '';
                            return;
                        }
                        const memberId = wrapper.dataset.memberId;
                        const member = teamMembers.find(m => m.id === memberId);
                        const chip = createModuleChipElement(value, member);
                        if (!chip) return;
                        const emptyState = list.querySelector('[data-role="empty-state"]');
                        if (emptyState) emptyState.remove();
                        list.appendChild(chip);
                        select.value = '';
                        refreshMemberAssignmentCount(wrapper);
                        updateModulePickerOptions(wrapper);
                        ensureAssignedListHasContent(wrapper);
                        lucide.createIcons();
                    }
                });
                moduleAssignmentContainer.addEventListener('click', event => {
                    const removeBtn = event.target.closest('[data-action="remove-member-module"]');
                    if (!removeBtn) return;
                    const chip = removeBtn.closest('[data-role="assigned-chip"]');
                    const wrapper = removeBtn.closest('[data-member-assignment]');
                    if (!chip || !wrapper) return;
                    chip.remove();
                    ensureAssignedListHasContent(wrapper);
                    refreshMemberAssignmentCount(wrapper);
                    updateModulePickerOptions(wrapper);
                });
                moduleAssignmentContainer.dataset.listenerAttached = 'true';
            }

            const messageSuggestionsContainer = document.getElementById('message-suggestions');
            if (messageSuggestionsContainer && !messageSuggestionsContainer.dataset.listenerAttached) {
                messageSuggestionsContainer.addEventListener('click', event => {
                    const button = event.target.closest('[data-action="use-suggestion"]');
                    if (!button) return;
                    const { suggestionId } = button.dataset;
                    if (!suggestionId) return;
                    handleSuggestionSelection(suggestionId);
                });
                messageSuggestionsContainer.dataset.listenerAttached = 'true';

            }
            
            function renderKanban(project) {
                const container = document.getElementById('kanban-container');
                if(!container) return;
                container.innerHTML = '';
                if (!project || !project.checklist) return;

                project.checklist.forEach(column => {
                    const tasksHTML = column.tasks.map(task => `
                        <div class="bg-slate-800 p-3 rounded-lg mb-2 flex items-center justify-between">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" ${task.done ? 'checked' : ''} class="w-4 h-4 text-cyan-400 bg-gray-700 border-gray-600 rounded focus:ring-cyan-500">
                                <span class="${task.done ? 'line-through text-slate-500' : ''}">${task.text}</span>
                            </label>
                        </div>
                    `).join('');

                    container.innerHTML += `
                        <div class="kanban-column">
                            <h5 class="font-bold mb-4 text-center">${column.fase}</h5>
                            <div class="space-y-2">${tasksHTML}</div>
                        </div>
                    `;
                });
            }

            // --- L√ìGICA DO MODAL UNIVERSAL (EQUIPE, SISTEMA, CLIENTE, STATUS) ---
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            document.getElementById('close-edit-modal-btn').addEventListener('click', () => closeGenericModal(editModal));
            document.getElementById('cancel-edit-btn').addEventListener('click', () => closeGenericModal(editModal));
            ['add-team-btn','add-sistema-btn','add-cliente-btn','add-status-btn', 'add-ideia-btn', 'add-kb-btn', 'add-mensagem-btn'].forEach(id => {
                const button = document.getElementById(id);
                if (button) {
                    button.addEventListener('click', () => openEditModalFor(id.split('-')[1], null, 'add'));
                }
            });


            const addSistemaToProjectBtn = document.getElementById('add-sistema-to-project-btn');
            if (addSistemaToProjectBtn) {
                addSistemaToProjectBtn.addEventListener('click', () => {
                    const select = document.getElementById('sistemas-select-add');
                    const selectedId = select?.value;
                    if (!selectedId) {
                        alert('Selecione um sistema para adicionar ao projeto.');
                        return;
                    }

                    const currentIds = Array.from(document.querySelectorAll('#sistemas-tags-container .sistema-tag')).map(tag => tag.dataset.id);
                    if (currentIds.includes(selectedId)) {
                        alert('Este sistema j√° foi adicionado ao projeto.');
                        return;
                    }

                    const updatedIds = [...currentIds, selectedId];
                    renderSistemasTags('sistemas-tags-container', updatedIds);
                    updateModuleAssignmentUI();
                    if (select) select.value = '';
                });
            }

            const sistemasTagsContainer = document.getElementById('sistemas-tags-container');
            if (sistemasTagsContainer) {
                sistemasTagsContainer.addEventListener('click', event => {
                    const removeBtn = event.target.closest('button[data-action="remove-sistema"]');
                    if (!removeBtn) return;
                    const tag = removeBtn.closest('.sistema-tag');
                    if (!tag) return;
                    tag.remove();
                    updateModuleAssignmentUI();
                });
            }



            ['import-team-btn', 'import-sistema-btn', 'import-client-btn'].forEach(id => {
                const button = document.getElementById(id);
                if (!button) return;
                button.addEventListener('click', () => {
                    importContext = button.dataset.importType || id.replace('import-', '').replace('-btn', '');
                    importInput.click();
                });
            });
            
            function openEditModalFor(type, id = null, mode = 'edit') {
                const modalTitle = document.getElementById('edit-modal-title');
                const formContent = document.getElementById('edit-form-content');
                
                editForm.dataset.type = type; editForm.dataset.id = id; editForm.dataset.mode = mode;
                formContent.innerHTML = '';

                let item = {};
                if (type === 'team') item = teamMembers.find(i => i.id === id) || {};
                if (type === 'sistema') item = sistemas.find(i => i.id === id) || {};
                if (type === 'cliente') item = clientes.find(i => i.id === id) || {};
                if (type === 'status') item = statuses.find(i => i.id === id) || {};
                if (type === 'ideia') item = ideias.find(i => i.id === id) || {};
                if (type === 'kb') item = knowledgeBase.find(i => i.id === id) || {};
                if (type === 'mensagem') item = whatsappMessages.find(i => i.id === id) || {};
                
                modalTitle.textContent = mode === 'add' ? `Adicionar ${type.charAt(0).toUpperCase() + type.slice(1)}` : `Editar ${type.charAt(0).toUpperCase() + type.slice(1)}`;

                if (type === 'team') formContent.innerHTML = `<div><label>Nome</label><input name="nome" value="${item.nome || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Cargo</label><input name="cargo" value="${item.cargo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Nome da Equipe</label><input name="teamName" value="${item.teamName || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="Ex.: Squad Financeiro"></div><div><label>E-mail</label><input type="email" name="email" value="${item.email || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Telefone (com DDI, ex: 5534...)</label><input type="tel" name="telefone" value="${item.telefone || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Habilidades (separadas por v√≠rgula)</label><input name="skills" value="${(item.skills || []).join(', ')}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div>`;
                if (type === 'sistema') formContent.innerHTML = `<div><label>Nome do Sistema</label><input name="nome" value="${item.nome || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Tipo</label><input name="tipo" value="${item.tipo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>`;
                if (type === 'cliente') formContent.innerHTML = `<div><label>Nome do Cliente</label><input name="nome" value="${item.nome || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Cidade</label><input name="cidade" value="${item.cidade || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Respons√°vel</label><input name="responsavel" value="${item.responsavel || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div>`;
                if (type === 'status') formContent.innerHTML = `<div><label>Nome do Status</label><input name="text" value="${item.text || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Cor</label><input name="color" type="color" value="${item.color || '#64748B'}" class="w-full h-10 p-1 bg-slate-700 rounded-lg"></div>`;
                if (type === 'ideia') formContent.innerHTML = `<div><label>T√≠tulo da Ideia</label><input name="titulo" value="${item.titulo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Categoria</label><input name="categoria" value="${item.categoria || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Descri√ß√£o</label><textarea name="descricao" rows="4" class="w-full bg-slate-700 p-2.5 rounded-lg">${item.descricao || ''}</textarea></div><div><label>Status</label><select name="status" class="w-full bg-slate-700 p-2.5 rounded-lg"><option>Nova</option><option>Em An√°lise</option><option>Aprovada</option><option>Rejeitada</option></select></div>`;
                if (type === 'kb') formContent.innerHTML = `<div><label>T√≠tulo do Artigo</label><input name="titulo" value="${item.titulo || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Categoria</label><input name="categoria" value="${item.categoria || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg"></div><div><label>Conte√∫do</label><textarea name="conteudo" rows="6" class="w-full bg-slate-700 p-2.5 rounded-lg">${item.conteudo || ''}</textarea></div>`;
                if (type === 'mensagem') formContent.innerHTML = `<div><label>T√≠tulo da Mensagem</label><input name="title" value="${item.title || ''}" class="w-full bg-slate-700 p-2.5 rounded-lg" required></div><div><label>Texto da Mensagem</label><textarea name="text" rows="4" class="w-full bg-slate-700 p-2.5 rounded-lg" placeholder="Use [NOME] para o nome do destinat√°rio e [EQUIPE] para o nome da equipe." required>${item.text || ''}</textarea></div>`;

                openGenericModal(editModal);
            }
            
            editForm.addEventListener('submit', e => {
                e.preventDefault();
                const { type, id, mode } = e.currentTarget.dataset;
                const formData = new FormData(e.currentTarget);
                const data = Object.fromEntries(formData.entries());

                const updateOrAdd = (arr, itemData) => {
                    if (mode === 'edit') arr[arr.findIndex(i => i.id === id)] = { ...arr.find(i => i.id === id), ...itemData };
                    else arr.push({ ...itemData, id: type.charAt(0).toUpperCase() + Date.now().toString().slice(-4) });
                };

                if (type === 'team') {
                    data.teamName = (data.teamName || '').trim();
                    data.skills = (data.skills || '').split(',').map(s=>s.trim()).filter(Boolean);
                    data.avatar = generateAvatarInitials(data.nome);
                    data.telefone = (data.telefone || '').replace(/\D/g,'');
                    updateOrAdd(teamMembers, data);
                }
                if (type === 'sistema') updateOrAdd(sistemas, data);
                if (type === 'cliente') updateOrAdd(clientes, data);
                if (type === 'status') updateOrAdd(statuses, data);
                if (type === 'ideia') updateOrAdd(ideias, data);
                if (type === 'kb') updateOrAdd(knowledgeBase, data);
                if (type === 'mensagem') {
                    data.text = (data.text || '').trim();
                    if (!data.text) {
                        alert('Informe o texto da mensagem.');
                        return;
                    }
                    if (!/\[NOME\]/i.test(data.text)) {
                        data.text = `Ol√° [NOME], ${data.text}`;
                    }
                    updateOrAdd(whatsappMessages, data);
                }

                renderAll();
                closeGenericModal(editModal);
            });

            // --- L√ìGICA DE EVENTOS (EDIT, DELETE) ---
            document.body.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                const whatsappBtn = e.target.closest('button[data-type="whatsapp"]');

                if (editBtn) {
                    const { type, id } = editBtn.dataset;
                    if (type === 'project') {
                        const projectIndex = projects.findIndex(p => p.id == id);
                        if (projectIndex === -1) return;
                        const project = normalizeProjectData(projects[projectIndex]);
                        projects[projectIndex] = project;
                        document.getElementById('project-modal-title').textContent = `Editar Projeto: ${clientes.find(c => c.id === project.clienteId)?.nome}`;
                        document.getElementById('projectId').value = project.id;
                        document.getElementById('cidade').value = project.cidade;
                        document.getElementById('progresso').value = project.progresso;
                        document.getElementById('dataInicio').value = project.dataInicio;
                        document.getElementById('dataPrevisao').value = project.dataPrevisao;
                        document.getElementById('contrato-numero').value = project.numeroContrato || '';
                        document.getElementById('contrato-vigencia').value = project.vigenciaContrato || '';

                        const contratoValorInput = document.getElementById('contrato-valor');
                        if (contratoValorInput) {
                            contratoValorInput.value = project.valorContrato ? project.valorContrato.toString().replace('.', ',') : '';
                        }
                        const contratoValidadeInput = document.getElementById('contrato-validade');
                        if (contratoValidadeInput) {
                            contratoValidadeInput.value = project.vigenciaContratoFim || '';
                        }
                        renderAditivosInputs(project.aditivos || []);


                        const obsContainer = document.getElementById('observacoes-container');
                        obsContainer.innerHTML = project.observacoes.map(obs => `<div class="text-xs bg-slate-800 p-2 rounded"><p>${obs.text}</p><p class="text-slate-400 text-right">${new Date(obs.date).toLocaleString('pt-BR')}</p></div>`).join('') || '<p class="text-xs text-slate-500">Nenhuma observa√ß√£o.</p>';

                        const normalizedAssignments = normalizeProjectAssignments(project);
                        project.equipe = normalizedAssignments;
                        const projectTeamIds = normalizedAssignments.map(e => e.memberId);
                        populateManagerSelects(project.gerTec, project.gerCom);
                        populateSistemasSelect('sistemas-select-add');
                        renderSistemasTags('sistemas-tags-container', project.sistemasIds);
                        populateClientesSelect(project.clienteId);
                        populateStatusSelect(project.statusId);
                        populateTeamCheckboxes('equipe-checkboxes', projectTeamIds);
                        updateModuleAssignmentUI(project);
                        renderKanban(project);
                        openGenericModal(projectModal);
                    } else {
                        openEditModalFor(type, id);
                    }
                }
                if(deleteBtn) {
                    const { type, id } = deleteBtn.dataset;
                    
                    const dataMap = {
                        project: { array: projects, getItemName: item => clientes.find(c => c.id === item.clienteId)?.nome || 'Projeto sem nome' },
                        sistema: { array: sistemas, getItemName: item => item.nome },
                        cliente: { array: clientes, getItemName: item => item.nome },
                        status:  { array: statuses, getItemName: item => item.text },
                        team:    { array: teamMembers, getItemName: item => item.nome },
                        mensagem: { array: whatsappMessages, getItemName: item => item.title },
                    };

                    const target = dataMap[type];
                    if (!target) return;

                    const item = target.array.find(i => i.id == id);
                    if (!item) return;

                    const itemName = target.getItemName(item);
                    
                    confirmAction('Confirmar Exclus√£o', `Tem certeza que deseja excluir "${itemName}"?`, () => {
                        const index = target.array.findIndex(i => i.id == id);
                        if (index > -1) {
                            target.array.splice(index, 1);
                        }
                        renderAll();
                    });
                }
                if(whatsappBtn){
                    const memberId = whatsappBtn.dataset.id;
                    const member = teamMembers.find(m => m.id === memberId);
                    if(member && member.telefone) {
                        openWhatsappModal(member);
                    } else {
                        alert('Telefone n√£o cadastrado para este membro da equipe.');
                    }
                }
            });
            
            // --- L√ìGICA DE NAVEGA√á√ÉO E TABS ---
            function navigateToView(viewId) {
                if (!viewId) return;
                const navLink = document.querySelector(`aside nav a[data-target="${viewId}"]`);
                if (navLink) {
                    navLink.click();
                } else {
                    document.querySelectorAll('main > div[data-view]').forEach(view => view.classList.add('hidden'));
                    document.getElementById(viewId)?.classList.remove('hidden');
                }
            }

            function setupDashboardShortcuts() {
                document.querySelectorAll('[data-dashboard-shortcut]').forEach(button => {
                    if (button.dataset.initialized) return;
                    button.dataset.initialized = 'true';
                    button.addEventListener('click', () => {
                        const { targetView, targetTab, action, targetButton } = button.dataset;
                        if (targetView) {
                            navigateToView(targetView);
                        }
                        if (targetTab) {
                            setTimeout(() => {
                                document.querySelector(`.tab-link[data-tab="${targetTab}"]`)?.click();
                            }, 60);
                        }
                        if (action === 'trigger-button' && targetButton) {
                            setTimeout(() => {
                                document.getElementById(targetButton)?.click();
                            }, 120);
                        }
                    });
                });
            }

            document.querySelectorAll('aside nav a').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const targetViewId = e.currentTarget.dataset.target;
                    document.querySelectorAll('main > div[data-view]').forEach(view => view.classList.add('hidden'));
                    document.getElementById(targetViewId).classList.remove('hidden');
                    document.querySelectorAll('aside nav a').forEach(l => l.classList.remove('gradient-bg'));
                    e.currentTarget.classList.add('gradient-bg');
                    if (targetViewId === 'relatorios-view') renderReports();
                    lucide.createIcons();
                });
            });

            document.querySelectorAll('.tab-link').forEach(tab => {
                tab.addEventListener('click', e => {
                    e.preventDefault();
                    const targetTabId = e.currentTarget.dataset.tab + '-tab';
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(targetTabId).classList.remove('hidden');
                    document.querySelectorAll('.tab-link').forEach(t => {
                        t.classList.remove('text-cyan-400', 'border-cyan-400', 'tab-link-active');
                        t.classList.add('text-slate-400', 'border-transparent');
                    });
                    e.currentTarget.classList.add('text-cyan-400', 'border-cyan-400', 'tab-link-active');
                    e.currentTarget.classList.remove('text-slate-400', 'border-transparent');
                });
            });
            
            // --- L√ìGICA DE CONFIRMA√á√ÉO ---
            const confirmModal = document.getElementById('confirm-modal');
            function confirmAction(title, message, callback) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                openGenericModal(confirmModal);
                const okBtn = document.getElementById('confirm-ok-btn');
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                newOkBtn.addEventListener('click', () => { callback(); closeGenericModal(confirmModal); });
            }
            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeGenericModal(confirmModal));

            // --- WHATSAPP MODAL ---
            const whatsappModal = document.getElementById('whatsapp-modal');
            document.getElementById('close-whatsapp-modal-btn').addEventListener('click', () => closeGenericModal(whatsappModal));
            
            function openWhatsappModal(member) {
                const list = document.getElementById('whatsapp-message-list');
                list.innerHTML = '';
                if (whatsappMessages.length === 0) {
                    list.innerHTML = '<p class="text-slate-400">Nenhuma mensagem personalizada cadastrada. Cadastre na tela "Mensagens".</p>';
                } else {
                    whatsappMessages.forEach(msg => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-3 bg-slate-700 hover:bg-slate-600 rounded-lg';
                        btn.innerHTML = `<div class="font-bold">${msg.title}</div><p class="text-sm text-slate-400 truncate">${msg.text}</p>`;
                        btn.onclick = () => {
                            const firstName = (member.nome || '').split(' ')[0] || member.nome;
                            const teamName = member.teamName || 'sua equipe';
                            let messageText = (msg.text || '').trim();
                            const hasNamePlaceholder = /\[NOME\]/i.test(messageText);
                            const hasTeamPlaceholder = /\[EQUIPE\]/i.test(messageText);

                            if (!hasNamePlaceholder) {
                                const greeting = `Ol√° ${firstName}`;
                                messageText = messageText ? `${greeting}, ${messageText}` : `${greeting}!`;
                            }

                            messageText = messageText
                                .replace(/\[NOME\]/gi, firstName)
                                .replace(/\[EQUIPE\]/gi, teamName);

                            if (!hasTeamPlaceholder && teamName && teamName !== 'sua equipe') {
                                messageText = `${messageText} (Equipe: ${teamName})`;
                            }

                            const url = `https://wa.me/${member.telefone}?text=${encodeURIComponent(messageText)}`;
                            window.open(url, '_blank');
                            closeGenericModal(whatsappModal);
                        };
                        list.appendChild(btn);
                    });
                }
                openGenericModal(whatsappModal);
            }

            // --- L√ìGICA DE BACKUP, RESTORE E IMPORT ---
            document.getElementById('backup-btn').addEventListener('click', () => {
                const data = JSON.stringify({ projects, teamMembers, sistemas, clientes, statuses, ideias, knowledgeBase, whatsappMessages }, null, 2);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([data], { type: 'application/json' }));
                a.download = `sgi-ai-backup.json`;
                a.click();
            });
            document.getElementById('restore-btn').addEventListener('click', () => document.getElementById('restore-input').click());
            document.getElementById('restore-input').addEventListener('change', e => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = re => {
                    try {
                        const data = JSON.parse(re.target.result);
                        if (data.projects && data.teamMembers && data.sistemas && data.clientes && data.statuses) {
                            projects = data.projects;
                            teamMembers = data.teamMembers;
                            sistemas = data.sistemas;
                            clientes = data.clientes;
                            statuses = Array.isArray(data.statuses) && data.statuses.length ? data.statuses : [...DEFAULT_STATUSES];
                            ideias = data.ideias || [];
                            knowledgeBase = data.knowledgeBase || [];
                            whatsappMessages = data.whatsappMessages || [];
                            renderAll(); alert('Backup restaurado!');
                        } else { alert('Arquivo de backup inv√°lido.'); }
                    } catch (err) { alert('Erro ao ler o arquivo.'); }
                };
                reader.readAsText(file); e.target.value = '';
            });
            importInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                if (!importContext) {
                    event.target.value = '';
                    alert('Selecione o tipo de importa√ß√£o antes de escolher um arquivo.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', codepage: 65001 });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' })
                            .filter(row => Array.isArray(row) && row.some(cell => String(cell ?? '').trim() !== ''));

                        const importedCount = handleImportData(importContext, rows);
                        if (importedCount > 0) {
                            renderAll();
                            alert(`${importedCount} registro${importedCount > 1 ? 's' : ''} importado${importedCount > 1 ? 's' : ''}!`);
                        } else {
                            alert('Nenhum registro v√°lido encontrado no arquivo selecionado.');
                        }
                    } catch (error) {
                        console.error('Erro ao importar arquivo:', error);
                        alert('N√£o foi poss√≠vel processar o arquivo informado.');
                    } finally {
                        importContext = null;
                        importInput.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // --- L√ìGICA DA IA ---
            function analyzeDataForAI() {
                const actionPointsContainer = document.getElementById('action-points-container');
                if (!actionPointsContainer) return;
                let insights = [];
                actionPointsContainer.innerHTML = '';

                projects.filter(p => p.statusId === 'ST4').forEach(p => insights.push(`<strong>Projeto em Risco:</strong> O projeto para <strong>${clientes.find(c=>c.id===p.clienteId)?.nome}</strong> precisa de aten√ß√£o imediata.`));
                projects.filter(p => p.progresso < 15 && p.statusId === 'ST2').forEach(p => insights.push(`<strong>In√≠cio Lento:</strong> Projeto <strong>${clientes.find(c=>c.id===p.clienteId)?.nome}</strong> tem apenas ${p.progresso}% de progresso.`));
                
                const managersInRisk = projects.filter(p => p.statusId === 'ST4').reduce((acc, p) => { acc[p.gerTec] = (acc[p.gerTec] || 0) + 1; return acc; }, {});
                Object.entries(managersInRisk).forEach(([managerId, count]) => {
                    if (count > 1) insights.push(`<strong>Sobrecarga de Risco:</strong> Gerente <strong>${teamMembers.find(m => m.id === managerId)?.nome}</strong> tem ${count} projetos em risco.`);
                });

                document.getElementById('ai-insight-text').textContent = insights.length ? insights[Math.floor(Math.random() * insights.length)].replace(/<[^>]*>/g, '') : "Nenhum insight cr√≠tico no momento. Bom trabalho!";
                
                if (insights.length) {
                    actionPointsContainer.innerHTML = insights.map(insight => `<div class="bg-slate-800/50 p-3 rounded-lg text-sm">${insight}</div>`).join('');
                } else {
                    actionPointsContainer.innerHTML = `<div class="text-center p-4"><i data-lucide="check-circle-2" class="mx-auto text-green-400 w-12 h-12"></i><p class="text-slate-400 mt-2">Tudo sob controle!</p></div>`;
                }
                lucide.createIcons();
            }


            // --- INICIALIZA√á√ÉO ---

            async function initializeApp() {
                try {
                    loadPersistedData();
                    await loadInitialBackupData();
                    await loadSampleCSVsIfNeeded();
                } catch (error) {
                    console.error('Erro ao inicializar dados padr√£o.', error);
                } finally {
                    renderAll();
                    setInterval(analyzeDataForAI, 10000);
                }
            }


            setupDashboardShortcuts();
            document.querySelector('[data-target="dashboard-view"]')?.click();
            initializeApp();
        });
    </script>
</body>
</html>

